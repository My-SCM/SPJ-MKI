<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Trading - Manajemen Transaksi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS untuk Export Excel Rapih -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Courier+Prime&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap');

        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .font-print { font-family: 'Courier Prime', monospace; }

        /* Styles for New Transaction Form */
        .input-field { 
            display: block; 
            width: 100%; 
            border-radius: 0.375rem; 
            border-width: 1px; 
            border-color: #d1d5db; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
            padding: 0.5rem; 
            font-size: 0.875rem; 
            line-height: 1.25rem; 
        }
        .input-field:focus { 
            border-color: #6366f1; 
            ring: 2px; 
            outline: 2px solid transparent; 
            outline-offset: 2px; 
            --tw-ring-color: #6366f1; 
        }
        .label-text { 
            display: block; 
            font-size: 0.875rem; 
            line-height: 1.25rem; 
            font-weight: 500; 
            color: #374151; 
            margin-bottom: 0.25rem;
        }

        @media print {
            body { background: white !important; }
            .no-print { display: none !important; }
            .print-area { display: block !important; padding: 0; margin: 0; width: 100%; }
            @page { size: auto; margin: 0mm; }
            
            .spj-blanko-data {
                position: relative;
                width: 210mm; 
                height: 140mm; 
            }
        }

        .preview-modal {
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Mobile optimization */
        input, select, textarea {
            font-size: 16px !important;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Truck, ClipboardList, CheckCircle, PlusCircle, User, Phone, 
            Box, Search, History, Settings, Save, AlertCircle, Users, 
            Package, Printer, Calendar, FileText, X, Eye, AlignJustify, 
            TrendingUp, MessageSquare, Pencil, Trash2, FileSpreadsheet, Download, Send, Lock, Info, AlertTriangle, LogOut,
            Scale, Receipt, Database, Server, Briefcase
        } from 'lucide-react';
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, setDoc, getDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCDb-ofn2ELU6mXsFPgyhT1MVPLsUPKNhg",
            authDomain: "spj-mki.firebaseapp.com",
            projectId: "spj-mki",
            storageBucket: "spj-mki.firebasestorage.app",
            messagingSenderId: "424266024897",
            appId: "1:424266024897:web:0d0b32610352120a665140"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-trading-v1';

        const TRUCK_TYPES = ['CDD', 'TRONTON', 'DUMPTRUK', 'WINGBOX', 'KONTAINER', 'BOX', 'MOBIL PRIBADI'];

        // --- TransactionForm Component Baru ---
        const TransactionForm = ({ user }) => {
            // State Header Form
            const [formData, setFormData] = useState({
                tujuan: '',
                no_sj: '',
                tanggal: new Date().toISOString().split('T')[0],
                no_so: '',
                transporter: '',
                driver: '',
                tipe_truk: '',
                no_truk: '',
                pallet: ''
            });

            // State Items Table
            const [items, setItems] = useState([
                { kode: '', nama: '', uom: '', qty_pesan: '', qty_kirim: '', berat: '', total_berat: '' }
            ]);

            // UI States
            const [showSettings, setShowSettings] = useState(false);
            const [showPreview, setShowPreview] = useState(false);
            const [previewUrl, setPreviewUrl] = useState('');
            const [statusMsg, setStatusMsg] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            // Print Config State
            const [layoutConfig, setLayoutConfig] = useState({
                pageSize: { w: 229, h: 162 }, 
                fontSize: 10,
                fontName: 'courier', 
                globalOffset: { x: 5, y: 13 },
                headerGap: 0,
                header: {
                    no_sj: { x: 160, y: 22 }, 
                    tanggal: { x: 160, y: 26 },
                    no_so: { x: 160, y: 32.7 },
                    transporter: { x: 160, y: 36.7 },
                    tipe_truk: { x: 160, y: 44 },
                    no_truk: { x: 160, y: 48 },
                    driver: { x: 160, y: 52 }
                },
                tujuan: { x: 20, y: 32, maxWidth: 80, lineHeight: 5 },
                table: {
                    startY: 68,     
                    rowHeight: 6,    
                    cols: {          
                        kode: 12, nama: 42, uom: 95, qty_pesan: 110, qty_kirim: 130, berat: 150, total: 175
                    }
                },
                footer: {
                    pallet: { x: 90, y: 130 }
                }
            });

            // Load Settings on Mount
            useEffect(() => {
                const x = localStorage.getItem('sj_config_offset_x');
                const y = localStorage.getItem('sj_config_offset_y');
                const hGap = localStorage.getItem('sj_config_header_gap');
                const fSize = localStorage.getItem('sj_config_font_size');

                setLayoutConfig(prev => ({
                    ...prev,
                    globalOffset: {
                        x: x !== null ? parseFloat(x) : prev.globalOffset.x,
                        y: y !== null ? parseFloat(y) : prev.globalOffset.y
                    },
                    headerGap: hGap !== null ? parseFloat(hGap) : prev.headerGap,
                    fontSize: fSize !== null ? parseFloat(fSize) : prev.fontSize
                }));
            }, []);

            // Handlers
            const handleHeaderChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const handleItemChange = (index, field, value) => {
                const newItems = [...items];
                newItems[index][field] = value;
                setItems(newItems);
            };

            const addItem = () => {
                setItems([...items, { kode: '', nama: '', uom: '', qty_pesan: '', qty_kirim: '', berat: '', total_berat: '' }]);
            };

            const removeItem = (index) => {
                if (items.length > 1) {
                    setItems(items.filter((_, i) => i !== index));
                }
            };

            // PDF Generation Logic (Ported from Snippet)
            const createPDFObject = (data) => {
                const { jsPDF } = window.jspdf;
                const cfg = layoutConfig;
                
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: [cfg.pageSize.w, cfg.pageSize.h]
                });

                doc.setFont(cfg.fontName, 'normal');
                doc.setFontSize(cfg.fontSize);

                const getX = (val) => val + cfg.globalOffset.x;
                const getY = (val) => val + cfg.globalOffset.y;
                const hGap = cfg.headerGap || 0;

                const txt = (str, x, y, lineIndex = 0) => { 
                    if(str) {
                        const finalY = getY(y) + (lineIndex * hGap);
                        doc.text(String(str).toUpperCase(), getX(x), finalY); 
                    }
                };

                const h = data.header;
                const hc = cfg.header;
                
                // Header fields
                txt(h.no_sj, hc.no_sj.x, hc.no_sj.y, 0);
                
                let tgl = h.tanggal;
                if (tgl) {
                    const d = new Date(tgl);
                    tgl = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`;
                }
                txt(tgl, hc.tanggal.x, hc.tanggal.y, 1);
                txt(h.no_so, hc.no_so.x, hc.no_so.y, 2);
                txt(h.transporter, hc.transporter.x, hc.transporter.y, 3);
                txt(h.tipe_truk, hc.tipe_truk.x, hc.tipe_truk.y, 4);
                txt(h.no_truk, hc.no_truk.x, hc.no_truk.y, 5);
                txt(h.driver, hc.driver.x, hc.driver.y, 6);

                const tc = cfg.tujuan;
                if (h.tujuan) {
                    const splitTujuan = doc.splitTextToSize(h.tujuan.toUpperCase(), tc.maxWidth);
                    doc.text(splitTujuan, getX(tc.x), getY(tc.y));
                }

                let currentY = cfg.table.startY;
                const tableC = cfg.table;
                
                data.items.forEach(item => {
                    const txtTable = (str, x, y) => { if(str) doc.text(String(str).toUpperCase(), getX(x), getY(y)); };
                    
                    txtTable(item.kode, tableC.cols.kode, currentY);
                    txtTable(item.nama, tableC.cols.nama, currentY);
                    txtTable(item.uom, tableC.cols.uom, currentY);
                    txtTable(item.qty_pesan, tableC.cols.qty_pesan, currentY);
                    txtTable(item.qty_kirim, tableC.cols.qty_kirim, currentY);
                    txtTable(item.berat, tableC.cols.berat, currentY);
                    txtTable(item.total_berat, tableC.cols.total, currentY);
                    currentY += tableC.rowHeight;
                });

                if (h.pallet) {
                    const txtFooter = (str, x, y) => { if(str) doc.text(String(str).toUpperCase(), getX(x), getY(y)); };
                    txtFooter(h.pallet, cfg.footer.pallet.x, cfg.footer.pallet.y);
                }

                return doc;
            };

            const handlePreview = () => {
                if(!formData.no_sj) { alert('Mohon isi No. Surat Jalan (minimal dummy) untuk preview'); return; }
                const doc = createPDFObject({ header: formData, items: items.filter(i => i.nama) });
                const pdfData = doc.output('datauristring');
                setPreviewUrl(pdfData);
                setShowPreview(true);
            };

            const saveSettings = (newConfig) => {
                setLayoutConfig(newConfig);
                localStorage.setItem('sj_config_offset_x', newConfig.globalOffset.x);
                localStorage.setItem('sj_config_offset_y', newConfig.globalOffset.y);
                localStorage.setItem('sj_config_header_gap', newConfig.headerGap);
                localStorage.setItem('sj_config_font_size', newConfig.fontSize);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                setStatusMsg('');

                try {
                    const dataToSave = {
                        ...formData,
                        items: items.filter(i => i.nama),
                        timestamp: serverTimestamp(),
                        createdBy: user.uid,
                        status: 'COMPLETED' // Assume completed directly or active
                    };

                    // Save to Firebase
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), dataToSave);

                    // Download PDF
                    const doc = createPDFObject({ header: formData, items: items.filter(i => i.nama) });
                    doc.save(`SJ_${formData.no_sj || 'Draft'}.pdf`);

                    setStatusMsg('Data Berhasil Disimpan & PDF Didownload!');
                    setFormData({ ...formData, no_sj: '', no_so: '', tujuan: '' }); // Clear some fields
                } catch (error) {
                    console.error("Error saving:", error);
                    setStatusMsg('Gagal menyimpan data: ' + error.message);
                }
                setIsSaving(false);
            };

            // Settings Modal Component
            const SettingsModal = () => {
                const [localCfg, setLocalCfg] = useState(layoutConfig);

                const updateVal = (key, val) => {
                    setLocalCfg(prev => {
                        const next = { ...prev };
                        if (key === 'offsetX') next.globalOffset.x = parseFloat(val);
                        if (key === 'offsetY') next.globalOffset.y = parseFloat(val);
                        if (key === 'headerGap') next.headerGap = parseFloat(val);
                        if (key === 'fontSize') next.fontSize = parseFloat(val);
                        return next;
                    });
                };

                const adjust = (key, delta) => {
                    let current = 0;
                    if (key === 'offsetX') current = localCfg.globalOffset.x;
                    if (key === 'offsetY') current = localCfg.globalOffset.y;
                    if (key === 'headerGap') current = localCfg.headerGap;
                    updateVal(key, (current + delta).toFixed(1));
                };

                return React.createElement("div", { className: "fixed inset-0 z-50 flex items-center justify-center p-4 preview-modal" },
                    React.createElement("div", { className: "bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden" },
                        React.createElement("div", { className: "flex justify-between items-center p-4 border-b" },
                            React.createElement("h3", { className: "text-lg font-medium" }, "Pengaturan Kertas"),
                            React.createElement("button", { onClick: () => setShowSettings(false), className: "text-gray-400 hover:text-gray-500" }, React.createElement(X, { size: 20 }))
                        ),
                        React.createElement("div", { className: "p-4 space-y-4 bg-gray-50" },
                            // Offset X
                            React.createElement("div", null,
                                React.createElement("label", { className: "block text-sm font-bold text-gray-700" }, "Geser Horizontal (X) - mm"),
                                React.createElement("div", { className: "flex items-center mt-1" },
                                    React.createElement("button", { onClick: () => adjust('offsetX', -1), className: "p-2 bg-gray-200 rounded-l hover:bg-gray-300" }, "-"),
                                    React.createElement("input", { type: "number", className: "block w-full text-center border-gray-300 h-9 border-t border-b", value: localCfg.globalOffset.x, onChange: e => updateVal('offsetX', e.target.value) }),
                                    React.createElement("button", { onClick: () => adjust('offsetX', 1), className: "p-2 bg-gray-200 rounded-r hover:bg-gray-300" }, "+")
                                )
                            ),
                            // Offset Y
                            React.createElement("div", null,
                                React.createElement("label", { className: "block text-sm font-bold text-gray-700" }, "Geser Vertikal (Y) - mm"),
                                React.createElement("div", { className: "flex items-center mt-1" },
                                    React.createElement("button", { onClick: () => adjust('offsetY', -1), className: "p-2 bg-gray-200 rounded-l hover:bg-gray-300" }, "-"),
                                    React.createElement("input", { type: "number", className: "block w-full text-center border-gray-300 h-9 border-t border-b", value: localCfg.globalOffset.y, onChange: e => updateVal('offsetY', e.target.value) }),
                                    React.createElement("button", { onClick: () => adjust('offsetY', 1), className: "p-2 bg-gray-200 rounded-r hover:bg-gray-300" }, "+")
                                )
                            ),
                            // Header Gap
                            React.createElement("div", null,
                                React.createElement("label", { className: "block text-sm font-bold text-gray-700" }, "Jarak Antar Baris Header - mm"),
                                React.createElement("div", { className: "flex items-center mt-1" },
                                    React.createElement("button", { onClick: () => adjust('headerGap', -0.5), className: "p-2 bg-gray-200 rounded-l hover:bg-gray-300" }, "-"),
                                    React.createElement("input", { type: "number", className: "block w-full text-center border-gray-300 h-9 border-t border-b", value: localCfg.headerGap, onChange: e => updateVal('headerGap', e.target.value) }),
                                    React.createElement("button", { onClick: () => adjust('headerGap', 0.5), className: "p-2 bg-gray-200 rounded-r hover:bg-gray-300" }, "+")
                                )
                            ),
                            // Font Size
                            React.createElement("div", null,
                                React.createElement("label", { className: "block text-sm font-bold text-gray-700" }, "Ukuran Font (pt)"),
                                React.createElement("input", { type: "number", className: "input-field mt-1", value: localCfg.fontSize, onChange: e => updateVal('fontSize', e.target.value) })
                            )
                        ),
                        React.createElement("div", { className: "p-4 flex flex-col gap-2" },
                            React.createElement("button", { 
                                onClick: () => {
                                    saveSettings(localCfg);
                                    setShowSettings(false);
                                    setTimeout(handlePreview, 300);
                                },
                                className: "w-full px-4 py-2 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700 flex justify-center items-center gap-2"
                            }, React.createElement("i", { className: "fa-solid fa-check-double" }), "Simpan & Lihat Preview"),
                            React.createElement("button", {
                                onClick: () => {
                                    saveSettings(localCfg);
                                    setShowSettings(false);
                                },
                                className: "w-full px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded hover:bg-gray-50 font-medium"
                            }, "Simpan Saja")
                        )
                    )
                );
            };

            return React.createElement("div", { className: "max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden relative no-print" },
                // Header
                React.createElement("div", { className: "bg-indigo-600 px-6 py-4 flex justify-between items-center" },
                    React.createElement("div", null,
                        React.createElement("h2", { className: "text-xl font-bold text-white" }, "Input Surat Jalan MKI"),
                        React.createElement("p", { className: "text-indigo-100 text-sm" }, "Setting Printer: Envelope C5 (229x162mm)")
                    ),
                    React.createElement("div", { className: "flex items-center gap-5" },
                        React.createElement("button", { onClick: handlePreview, className: "text-indigo-200 hover:text-white transition flex flex-col items-center group", title: "Preview PDF" },
                            React.createElement("i", { className: "fa-solid fa-eye text-xl mb-1 group-hover:scale-110 transition-transform" }),
                            React.createElement("span", { className: "text-[10px] font-medium uppercase tracking-wider" }, "Preview")
                        ),
                        React.createElement("div", { className: "h-8 w-px bg-indigo-500" }),
                        React.createElement("button", { onClick: () => setShowSettings(true), className: "text-indigo-200 hover:text-white transition flex flex-col items-center group", title: "Pengaturan Kertas" },
                            React.createElement("i", { className: "fa-solid fa-gear text-xl mb-1 group-hover:rotate-45 transition-transform duration-300" }),
                            React.createElement("span", { className: "text-[10px] font-medium uppercase tracking-wider" }, "Setting")
                        )
                    )
                ),

                // Form
                React.createElement("form", { onSubmit: handleSave, className: "p-6 space-y-6" },
                    React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-6" },
                        // Column 1
                        React.createElement("div", { className: "space-y-4" },
                            React.createElement("div", null,
                                React.createElement("label", { className: "label-text" }, "Tujuan (Nama & Alamat Customer)"),
                                React.createElement("textarea", { 
                                    name: "tujuan", 
                                    required: true, 
                                    className: "input-field h-32", 
                                    placeholder: "PT. CONTOH CUSTOMER\nJl. Raya Industri No. 1...",
                                    value: formData.tujuan,
                                    onChange: handleHeaderChange
                                })
                            )
                        ),
                        // Column 2
                        React.createElement("div", { className: "space-y-3 bg-gray-50 p-4 rounded-md border" },
                            React.createElement("div", { className: "grid grid-cols-2 gap-2" },
                                React.createElement("div", null,
                                    React.createElement("label", { className: "label-text" }, "No. Surat Jalan"),
                                    React.createElement("input", { type: "text", name: "no_sj", required: true, className: "input-field", placeholder: "SDO-MKI/...", value: formData.no_sj, onChange: handleHeaderChange })
                                ),
                                React.createElement("div", null,
                                    React.createElement("label", { className: "label-text" }, "Tanggal"),
                                    React.createElement("input", { type: "date", name: "tanggal", required: true, className: "input-field", value: formData.tanggal, onChange: handleHeaderChange })
                                )
                            ),
                            React.createElement("div", null,
                                React.createElement("label", { className: "label-text" }, "No. Sales Order (SO)"),
                                React.createElement("input", { type: "text", name: "no_so", className: "input-field", value: formData.no_so, onChange: handleHeaderChange })
                            ),
                            React.createElement("div", { className: "grid grid-cols-2 gap-2" },
                                React.createElement("div", null,
                                    React.createElement("label", { className: "label-text" }, "Transporter"),
                                    React.createElement("input", { type: "text", name: "transporter", className: "input-field", value: formData.transporter, onChange: handleHeaderChange })
                                ),
                                React.createElement("div", null,
                                    React.createElement("label", { className: "label-text" }, "Nama Driver"),
                                    React.createElement("input", { type: "text", name: "driver", className: "input-field", value: formData.driver, onChange: handleHeaderChange })
                                )
                            ),
                            React.createElement("div", { className: "grid grid-cols-2 gap-2" },
                                React.createElement("div", null,
                                    React.createElement("label", { className: "label-text" }, "Tipe Truk"),
                                    React.createElement("input", { type: "text", name: "tipe_truk", className: "input-field", value: formData.tipe_truk, onChange: handleHeaderChange })
                                ),
                                React.createElement("div", null,
                                    React.createElement("label", { className: "label-text" }, "No. Polisi Truk"),
                                    React.createElement("input", { type: "text", name: "no_truk", className: "input-field", value: formData.no_truk, onChange: handleHeaderChange })
                                )
                            )
                        )
                    ),

                    // Table Items
                    React.createElement("div", null,
                        React.createElement("h3", { className: "text-lg font-medium text-gray-900 border-b pb-2 mb-3" }, "Daftar Barang"),
                        React.createElement("div", { className: "overflow-x-auto" },
                            React.createElement("table", { className: "min-w-full divide-y divide-gray-200" },
                                React.createElement("thead", { className: "bg-gray-50" },
                                    React.createElement("tr", null,
                                        ["Kode", "Nama Item", "UoM", "Qty Pesan", "Qty Kirim", "Berat (kg)", "Total (Ton)", ""].map((h, i) => 
                                            React.createElement("th", { key: i, className: `px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase ${h === "Nama Item" ? "w-1/3" : ""}` }, h)
                                        )
                                    )
                                ),
                                React.createElement("tbody", { className: "bg-white divide-y divide-gray-200" },
                                    items.map((item, idx) => 
                                        React.createElement("tr", { key: idx },
                                            React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "text", className: "input-field text-xs", value: item.kode, onChange: e => handleItemChange(idx, 'kode', e.target.value) })),
                                            React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "text", className: "input-field text-xs", value: item.nama, onChange: e => handleItemChange(idx, 'nama', e.target.value) })),
                                            React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "text", className: "input-field text-xs", value: item.uom, onChange: e => handleItemChange(idx, 'uom', e.target.value) })),
                                            React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "number", className: "input-field text-xs", value: item.qty_pesan, onChange: e => handleItemChange(idx, 'qty_pesan', e.target.value) })),
                                            React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "number", className: "input-field text-xs", value: item.qty_kirim, onChange: e => handleItemChange(idx, 'qty_kirim', e.target.value) })),
                                            React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "number", className: "input-field text-xs", step: "0.01", value: item.berat, onChange: e => handleItemChange(idx, 'berat', e.target.value) })),
                                            React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "number", className: "input-field text-xs", step: "0.01", value: item.total_berat, onChange: e => handleItemChange(idx, 'total_berat', e.target.value) })),
                                            React.createElement("td", { className: "px-2 py-1 text-center" }, 
                                                React.createElement("button", { type: "button", onClick: () => removeItem(idx), className: "text-red-600 hover:text-red-900 font-bold" }, "X")
                                            )
                                        )
                                    )
                                )
                            )
                        ),
                        React.createElement("button", { type: "button", onClick: addItem, className: "mt-3 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200" },
                            "+ Tambah Baris"
                        )
                    ),

                    // Pallet
                    React.createElement("div", { className: "grid grid-cols-2 gap-4" },
                        React.createElement("div", null,
                            React.createElement("label", { className: "label-text" }, "Jumlah Pallet"),
                            React.createElement("input", { type: "text", name: "pallet", className: "input-field w-32", value: formData.pallet, onChange: handleHeaderChange })
                        )
                    ),

                    // Actions
                    React.createElement("div", { className: "flex justify-end gap-3 pt-4 border-t items-center" },
                        React.createElement("button", { type: "button", onClick: handlePreview, className: "inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" },
                            React.createElement("i", { className: "fa-solid fa-eye mr-2 mt-0.5" }), " Cek Preview"
                        ),
                        React.createElement("button", { type: "submit", disabled: isSaving, className: "inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50" },
                            isSaving ? "Menyimpan..." : "Simpan & Download PDF"
                        )
                    ),

                    statusMsg && React.createElement("div", { className: `p-4 rounded-md ${statusMsg.includes('Gagal') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}` }, statusMsg)
                ),

                // Modals
                showSettings && React.createElement(SettingsModal),
                showPreview && React.createElement("div", { className: "fixed inset-0 z-50 flex items-center justify-center p-4 preview-modal" },
                    React.createElement("div", { className: "bg-white rounded-lg shadow-xl w-full max-w-5xl h-[90vh] flex flex-col" },
                        React.createElement("div", { className: "bg-gray-100 px-4 py-3 border-b flex justify-between items-center" },
                            React.createElement("h3", { className: "text-lg font-medium text-gray-900" }, "Preview PDF"),
                            React.createElement("div", { className: "flex gap-2" },
                                React.createElement("button", { onClick: () => { setShowPreview(false); setShowSettings(true); }, className: "text-sm px-3 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200" },
                                    React.createElement("i", { className: "fa-solid fa-gear mr-1" }), "Atur Lagi"
                                ),
                                React.createElement("button", { onClick: () => setShowPreview(false), className: "text-gray-500 hover:text-gray-700 ml-2" },
                                    React.createElement("i", { className: "fa-solid fa-times text-xl" })
                                )
                            )
                        ),
                        React.createElement("div", { className: "flex-grow bg-gray-500 p-4" },
                            React.createElement("iframe", { src: previewUrl, className: "w-full h-full rounded shadow-lg border-0" })
                        )
                    )
                )
            );
        };

        // --- DEFINISI KOMPONEN LAIN (TIDAK BERUBAH) ---

        // HALAMAN LOGIN UTAMA
        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                // HARDCODED CREDENTIALS
                if (username === 'admin' && password === 'admin123') {
                    onLogin('admin');
                } else if (username === 'transporter' && password === 'transporter123') {
                    onLogin('transporter');
                } else {
                    setError('Username atau Password salah!');
                }
            };

            return React.createElement("div", { className: "min-h-screen flex items-center justify-center bg-slate-200 p-4" },
                React.createElement("div", { className: "bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm" },
                    React.createElement("div", { className: "text-center mb-6" },
                        React.createElement(TrendingUp, { className: "mx-auto text-blue-600 mb-2", size: 48 }),
                        React.createElement("h1", { className: "text-2xl font-black text-slate-800" }, "MY TRADING"),
                        React.createElement("p", { className: "text-slate-500 text-sm" }, "Sistem Logistik Terpadu")
                    ),
                    error && React.createElement("div", { className: "bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 text-center font-bold" }, error),
                    React.createElement("form", { onSubmit: handleLogin, className: "space-y-4" },
                        React.createElement("div", null,
                            React.createElement("label", { className: "block text-xs font-bold text-slate-500 mb-1" }, "USERNAME"),
                            React.createElement("input", { 
                                type: "text", 
                                className: "w-full p-3 border rounded-xl bg-slate-50 focus:bg-white focus:ring-2 ring-blue-500 outline-none transition-all",
                                value: username,
                                onChange: e => setUsername(e.target.value),
                                placeholder: "Masukkan username..."
                            })
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { className: "block text-xs font-bold text-slate-500 mb-1" }, "PASSWORD"),
                            React.createElement("input", { 
                                type: "password", 
                                className: "w-full p-3 border rounded-xl bg-slate-50 focus:bg-white focus:ring-2 ring-blue-500 outline-none transition-all",
                                value: password,
                                onChange: e => setPassword(e.target.value),
                                placeholder: "Masukkan password..."
                            })
                        ),
                        React.createElement("button", { 
                            type: "submit",
                            className: "w-full bg-blue-700 text-white font-bold py-3 rounded-xl hover:bg-blue-800 transition-transform active:scale-95 shadow-lg shadow-blue-200"
                        }, "MASUK SISTEM"),
                        React.createElement("div", { className: "text-center mt-4 text-xs text-slate-400" },
                           "Versi 1.2.0 - Secure Login"
                        )
                    )
                )
            );
        };

        // HALAMAN INSTRUKSI KERJA (PANDUAN)
        const InstructionPage = () => {
            return React.createElement("div", { className: "space-y-6 pb-20 no-print" },
                // Header
                React.createElement("div", { className: "bg-white p-6 rounded-xl border shadow-sm" },
                    React.createElement("h2", { className: "text-xl font-bold mb-2 flex items-center gap-2" },
                        React.createElement(Info, { className: "text-blue-600" }), " Instruksi Kerja (SOP)"
                    ),
                    React.createElement("p", { className: "text-sm text-slate-600" },
                        "Panduan standar operasional untuk penggunaan aplikasi MyTrading."
                    )
                ),

                // 1. Master Produk
                React.createElement("div", { className: "bg-white p-5 rounded-xl border shadow-sm" },
                    React.createElement("h3", { className: "font-bold text-md mb-3 text-slate-800 flex items-center gap-2" },
                        React.createElement(Package, { className: "text-blue-500", size: 18 }), " 1. Master Produk / Barang"
                    ),
                    React.createElement("img", {
                        src: "https://lh3.googleusercontent.com/d/1wIkcD0P8Cp353LYf72gMzm3tTyDP0AGa",
                        className: "w-full rounded-lg border mb-3"
                    }),
                    React.createElement("ul", { className: "list-disc list-inside text-xs text-slate-700 space-y-1 bg-slate-50 p-3 rounded-lg" },
                        React.createElement("li", null, "Gunakan menu ini untuk mendaftarkan barang baru."),
                        React.createElement("li", null, "Input Nama Barang, Satuan, dan Keterangan.")
                    )
                ),

                // 2. Customer
                React.createElement("div", { className: "bg-white p-5 rounded-xl border shadow-sm" },
                    React.createElement("h3", { className: "font-bold text-md mb-3 text-slate-800 flex items-center gap-2" },
                        React.createElement(Users, { className: "text-blue-500", size: 18 }), " 2. Menu Customer"
                    ),
                    React.createElement("img", {
                        src: "https://lh3.googleusercontent.com/d/1-837eyrQbjLIwWcYYXFFEeFqynGbo4hO",
                        className: "w-full rounded-lg border mb-3"
                    }),
                    React.createElement("ul", { className: "list-disc list-inside text-xs text-slate-700 space-y-1 bg-slate-50 p-3 rounded-lg" },
                        React.createElement("li", null, "Input Nama Customer dan Alamat Lengkap."),
                    )
                ),

                // 3. Armada
                React.createElement("div", { className: "bg-white p-5 rounded-xl border shadow-sm" },
                    React.createElement("h3", { className: "font-bold text-md mb-3 text-slate-800 flex items-center gap-2" },
                        React.createElement(Truck, { className: "text-blue-500", size: 18 }), " 3. Armada"
                    ),
                    React.createElement("img", {
                        src: "https://lh3.googleusercontent.com/d/1nxv2JuAXul-GP01dnk4NMSCJOi0Rdr6U",
                        className: "w-full rounded-lg border mb-3"
                    }),
                     React.createElement("ul", { className: "list-disc list-inside text-xs text-slate-700 space-y-1 bg-slate-50 p-3 rounded-lg" },
                        React.createElement("li", null, "Daftarkan Nopol & Driver baru di menu Armada."),
                        React.createElement("li", null, "Isi No Tiket Timbangan & Qty Netto."),
                    )
                ),

                // 4. Transaksi
                React.createElement("div", { className: "bg-white p-5 rounded-xl border shadow-sm" },
                    React.createElement("h3", { className: "font-bold text-md mb-3 text-slate-800 flex items-center gap-2" },
                        React.createElement(ClipboardList, { className: "text-blue-500", size: 18 }), " 4. Menu Transaksi"
                    ),
                    React.createElement("img", {
                        src: "https://lh3.googleusercontent.com/d/1pRVbVJeeqZDVfRp_QmCPl0w5bXkzdcw5",
                        className: "w-full rounded-lg border mb-3"
                    }),
                      React.createElement("ul", { className: "list-disc list-inside text-xs text-slate-700 space-y-1 bg-slate-50 p-3 rounded-lg" },
                        React.createElement("li", null, "Pilih Tanggal, Truk, Customer, dan Barang."),
                        React.createElement("li", null, "Klik Preview & Cetak untuk mencetak Surat Jalan.")
                    )
                )
            );
        };

        const RecapPage = ({ user }) => {
            const [transactions, setTransactions] = useState([]);
            const [filter, setFilter] = useState({ 
                startDate: new Date().toISOString().split('T')[0], 
                endDate: new Date().toISOString().split('T')[0] 
            });
            const [editValues, setEditValues] = useState({});
            const [editStatusValues, setEditStatusValues] = useState({});

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'));
                const unsub = onSnapshot(q, s => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    setTransactions(data.sort((a,b) => new Date(b.date) - new Date(a.date)));
                });
                return () => unsub();
            }, [user]);

            const filteredData = transactions.filter(t => {
                return t.date >= filter.startDate && t.date <= filter.endDate;
            });

            const handleSaveActual = async (id) => {
                const val = editValues[id];
                if (val === undefined || val === '') return;
                
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id), {
                        qtyActual: Number(val)
                    });
                    setEditValues(prev => {
                        const next = {...prev};
                        delete next[id];
                        return next;
                    });
                    alert("Qty Actual berhasil disimpan!");
                } catch (err) {
                    console.error("Error saving actual qty:", err);
                    alert("Gagal menyimpan data.");
                }
            };

            const handleSaveStatus = async (id) => {
                const val = editStatusValues[id];
                if (val === undefined) return;

                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id), {
                        validationStatus: val
                    });
                    setEditStatusValues(prev => {
                        const next = {...prev};
                        delete next[id];
                        return next;
                    });
                    alert("Status Validasi berhasil disimpan!");
                } catch (err) {
                    console.error("Error saving status:", err);
                    alert("Gagal menyimpan status.");
                }
            };

            const downloadExcel = () => {
                if(filteredData.length === 0) return alert("Tidak ada data untuk didownload");

                const dataForExcel = filteredData.map(row => ({
                    "Tanggal": row.date,
                    "No Polisi": row.nopol,
                    "Driver": row.driver,
                    "No HP": row.noHp || '-',
                    "Customer": row.customerName,
                    "Alamat Customer": row.customerAddress || '',
                    "Barang": row.itemName,
                    "Qty Kirim": Number(row.qty), 
                    "Qty Actual": row.qtyActual ? Number(row.qtyActual) : '-',
                    "Validasi": row.validationStatus || 'Pending',
                    "Satuan": row.uom,
                    "Status Jalan": row.status === 'COMPLETED' ? 'Selesai' : 'Dalam Perjalanan',
                    "Keterangan": row.notes || ''
                }));

                const ws = window.XLSX.utils.json_to_sheet(dataForExcel);
                const wscols = [
                    {wch: 12}, {wch: 15}, {wch: 20}, {wch: 15}, 
                    {wch: 25}, {wch: 40}, {wch: 20}, {wch: 10}, 
                    {wch: 10}, {wch: 10}, {wch: 15}, {wch: 30}
                ];
                ws['!cols'] = wscols;
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Rekap Transaksi");
                window.XLSX.writeFile(wb, `Rekap_Transaksi_${filter.startDate}_sd_${filter.endDate}.xlsx`);
            };

            return React.createElement("div", { className: "space-y-6 no-print" },
                React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border shadow-sm" },
                    React.createElement("h2", { className: "font-bold mb-4 flex gap-2 items-center" }, 
                        React.createElement(FileSpreadsheet, { className: "text-green-600" }), " Rekapitulasi Data & Validasi"
                    ),
                    
                    React.createElement("div", { className: "flex flex-col md:flex-row gap-4 items-end mb-6" },
                        React.createElement("div", { className: "w-full" },
                            React.createElement("label", { className: "text-xs font-bold text-slate-500" }, "DARI TANGGAL"),
                            React.createElement("input", { type: "date", className: "w-full p-2 border rounded-lg", value: filter.startDate, onChange: e => setFilter({...filter, startDate: e.target.value}) })
                        ),
                        React.createElement("div", { className: "w-full" },
                            React.createElement("label", { className: "text-xs font-bold text-slate-500" }, "SAMPAI TANGGAL"),
                            React.createElement("input", { type: "date", className: "w-full p-2 border rounded-lg", value: filter.endDate, onChange: e => setFilter({...filter, endDate: e.target.value}) })
                        ),
                        React.createElement("button", { onClick: downloadExcel, className: "w-full md:w-auto bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 flex gap-2 items-center justify-center transition-all shadow-md active:scale-95" }, 
                            React.createElement(Download, { size: 18 }), "Download .XLSX"
                        )
                    ),

                    React.createElement("div", { className: "overflow-x-auto border rounded-lg" },
                        React.createElement("table", { className: "w-full text-xs text-left whitespace-nowrap" },
                            React.createElement("thead", { className: "bg-slate-100 text-slate-600 uppercase font-bold" },
                                React.createElement("tr", null,
                                    React.createElement("th", { className: "p-3 border-b" }, "Tanggal"),
                                    React.createElement("th", { className: "p-3 border-b" }, "Nopol"),
                                    React.createElement("th", { className: "p-3 border-b" }, "Driver"),
                                    React.createElement("th", { className: "p-3 border-b" }, "Customer"),
                                    React.createElement("th", { className: "p-3 border-b" }, "Barang"),
                                    React.createElement("th", { className: "p-3 border-b text-right" }, "Qty Kirim"),
                                    React.createElement("th", { className: "p-3 border-b text-center bg-yellow-50" }, "Qty Actual"),
                                    React.createElement("th", { className: "p-3 border-b text-center bg-blue-50" }, "Validasi"), 
                                    React.createElement("th", { className: "p-3 border-b" }, "Status Jalan"),
                                    React.createElement("th", { className: "p-3 border-b" }, "Keterangan")
                                )
                            ),
                            React.createElement("tbody", null,
                                filteredData.length === 0 ? 
                                React.createElement("tr", null, React.createElement("td", { colSpan: 10, className: "p-8 text-center text-slate-400" }, "Tidak ada data pada periode ini.")) :
                                filteredData.map(row => 
                                    React.createElement("tr", { key: row.id, className: "hover:bg-slate-50 border-b last:border-0" },
                                        React.createElement("td", { className: "p-3" }, row.date),
                                        React.createElement("td", { className: "p-3 font-bold" }, row.nopol),
                                        React.createElement("td", { className: "p-3" }, row.driver),
                                        React.createElement("td", { className: "p-3" }, row.customerName),
                                        React.createElement("td", { className: "p-3" }, row.itemName),
                                        React.createElement("td", { className: "p-3 text-right font-bold" }, `${row.qty} ${row.uom}`),
                                        
                                        React.createElement("td", { className: "p-2 bg-yellow-50" },
                                            React.createElement("div", { className: "flex items-center justify-center gap-1" },
                                                React.createElement("input", {
                                                    type: "number",
                                                    placeholder: row.qtyActual || "0",
                                                    className: "w-16 p-1 border rounded text-right font-mono focus:border-blue-500 outline-none text-xs",
                                                    value: editValues[row.id] !== undefined ? editValues[row.id] : (row.qtyActual || ''),
                                                    onChange: (e) => setEditValues({...editValues, [row.id]: e.target.value})
                                                }),
                                                editValues[row.id] !== undefined && React.createElement("button", {
                                                    onClick: () => handleSaveActual(row.id),
                                                    className: "p-1 bg-blue-500 text-white rounded hover:bg-blue-600 shadow-sm",
                                                    title: "Simpan Qty"
                                                }, React.createElement(Save, { size: 14 }))
                                            )
                                        ),

                                        React.createElement("td", { className: "p-2 bg-blue-50 text-center" },
                                            React.createElement("div", { className: "flex items-center justify-center gap-1" },
                                                React.createElement("select", {
                                                    className: `p-1 border rounded text-xs outline-none cursor-pointer ${
                                                        (editStatusValues[row.id] || row.validationStatus) === 'Reject' ? 'text-red-600 font-bold bg-red-50' : 
                                                        (editStatusValues[row.id] || row.validationStatus) === 'Acc' ? 'text-green-600 font-bold bg-green-50' : 'text-slate-500'
                                                    }`,
                                                    value: editStatusValues[row.id] !== undefined ? editStatusValues[row.id] : (row.validationStatus || ''),
                                                    onChange: (e) => setEditStatusValues({...editStatusValues, [row.id]: e.target.value})
                                                },
                                                    React.createElement("option", { value: "" }, "- Pilih -"),
                                                    React.createElement("option", { value: "Acc" }, "Acc"),
                                                    React.createElement("option", { value: "Reject" }, "Reject")
                                                ),
                                                editStatusValues[row.id] !== undefined && React.createElement("button", {
                                                    onClick: () => handleSaveStatus(row.id),
                                                    className: "p-1 bg-blue-500 text-white rounded hover:bg-blue-600 shadow-sm",
                                                    title: "Simpan Status"
                                                }, React.createElement(Save, { size: 14 }))
                                            )
                                        ),

                                        React.createElement("td", { className: "p-3" }, 
                                            React.createElement("span", { className: `px-2 py-1 rounded text-[10px] font-bold ${row.status === 'COMPLETED' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}` }, 
                                                row.status === 'COMPLETED' ? 'Selesai' : 'Jalan'
                                            )
                                        ),
                                        React.createElement("td", { className: "p-3 italic text-slate-500 max-w-xs truncate" }, row.notes || '-')
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        const TransactionHistory = ({ user }) => {
            const [transactions, setTransactions] = useState([]);
            useEffect(() => {
                if (!user) return;
                const unsub = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'transactions')), s => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    setTransactions(data.sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0)));
                }, (err) => console.error(err));
                return () => unsub();
            }, [user]);

            const handleFinish = async (id) => {
                if(!confirm("Selesaikan transaksi ini? Armada akan kembali tersedia.")) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id), { status: 'COMPLETED', completedAt: serverTimestamp() });
            };

            const handleDelete = async (id) => {
                const password = prompt("Masukkan Password Admin untuk Hapus Transaksi:");
                if (password !== 'admin123') {
                    alert("Password Salah! Akses ditolak.");
                    return;
                }

                if(!confirm("PERINGATAN: Data transaksi akan dihapus permanen dan tidak bisa dikembalikan. Lanjutkan?")) return;
                
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id));
                } catch (err) {
                    console.error("Gagal menghapus:", err);
                    alert("Gagal menghapus data.");
                }
            };

            return React.createElement("div", { className: "space-y-3 no-print" },
                React.createElement("h2", { className: "font-bold text-lg flex gap-2 items-center" }, React.createElement(History, { className: "text-blue-500" }), " Log Perjalanan / Transaksi"),
                transactions.length === 0 ? 
                    React.createElement("p", {className: "text-center text-slate-400 py-10"}, "Belum ada riwayat transaksi.") :
                    transactions.map(t => React.createElement("div", { key: t.id, className: `bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center ${t.status === 'ACTIVE' ? 'border-l-4 border-l-orange-500' : 'opacity-60'}` },
                        React.createElement("div", null,
                            React.createElement("p", { className: "font-black text-lg" }, t.nopol),
                            React.createElement("p", { className: "text-sm font-bold text-slate-600" }, t.customerName),
                            t.items && t.items.length > 0 && React.createElement("div", { className: "text-xs text-blue-600" }, 
                                t.items.map((i, idx) => React.createElement("span", { key: idx }, `${i.nama} (${i.qty_kirim} ${i.uom})${idx < t.items.length-1 ? ', ' : ''}`))
                            )
                        ),
                        React.createElement("div", { className: "flex items-center gap-2" },
                            t.status === 'ACTIVE' && React.createElement("button", { onClick: () => handleFinish(t.id), className: "bg-orange-500 text-white text-xs px-4 py-2 rounded-lg font-bold hover:bg-orange-600 transition-colors" }, "SELESAI"),
                            React.createElement("button", { onClick: () => handleDelete(t.id), className: "p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors", title: "Hapus Permanen" }, 
                                React.createElement(Trash2, { size: 18 })
                            )
                        )
                    ))
            );
        };

        const MasterCustomerForm = ({ user }) => {
            const [formData, setFormData] = useState({ name: '', address: '' });
            const [customers, setCustomers] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [editData, setEditData] = useState({});

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'customers'));
                const unsub = onSnapshot(q, s => setCustomers(s.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => unsub();
            }, [user]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'customers'), { ...formData, createdAt: serverTimestamp() });
                setFormData({ name: '', address: '' });
            };

            const startEdit = (c) => {
                setEditingId(c.id);
                setEditData(c);
            };

            const saveEdit = async () => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'customers', editingId), {
                        name: editData.name,
                        address: editData.address
                    });
                    setEditingId(null);
                } catch (err) {
                    console.error("Gagal update customer:", err);
                    alert("Gagal update data");
                }
            };

            const deleteCustomer = async (id) => {
                if(confirm("Hapus customer ini?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'customers', id));
                }
            };

            return React.createElement("div", { className: "space-y-6 no-print" },
                React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border" },
                    React.createElement("h2", { className: "font-bold mb-4 flex gap-2 items-center" }, React.createElement(Users, { className: "text-blue-500" }), " Data Customer"),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-3" },
                        React.createElement("input", { required: true, placeholder: "Nama Perusahaan / Toko", className: "w-full p-2 border rounded-lg", value: formData.name, onChange: e => setFormData({...formData, name: e.target.value}) }),
                        React.createElement("textarea", { placeholder: "Alamat Lengkap", className: "w-full p-2 border rounded-lg", value: formData.address, onChange: e => setFormData({...formData, address: e.target.value}) }),
                        React.createElement("button", { className: "w-full bg-slate-800 text-white p-2 rounded-lg font-bold hover:bg-black transition-colors" }, "Simpan Customer")
                    )
                ),
                React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border shadow-sm" },
                    React.createElement("h3", { className: "font-bold mb-4" }, "Daftar Customer"),
                    React.createElement("div", { className: "overflow-x-auto" },
                        React.createElement("table", { className: "w-full text-sm text-left whitespace-nowrap" },
                            React.createElement("thead", { className: "bg-slate-50 text-slate-500 uppercase font-bold" },
                                React.createElement("tr", null,
                                    React.createElement("th", { className: "p-3" }, "Nama"),
                                    React.createElement("th", { className: "p-3" }, "Alamat"),
                                    React.createElement("th", { className: "p-3 text-right" }, "Aksi")
                                )
                            ),
                            React.createElement("tbody", null,
                                customers.length === 0 ? 
                                React.createElement("tr", null, React.createElement("td", { colSpan: 3, className: "p-4 text-center text-slate-400" }, "Belum ada customer.")) :
                                customers.map(c => 
                                    editingId === c.id ?
                                    React.createElement("tr", { key: c.id, className: "border-b bg-blue-50" },
                                        React.createElement("td", { className: "p-2" }, React.createElement("input", { className: "w-full p-1 border rounded", value: editData.name, onChange: e => setEditData({...editData, name: e.target.value}) })),
                                        React.createElement("td", { className: "p-2" }, React.createElement("input", { className: "w-full p-1 border rounded", value: editData.address, onChange: e => setEditData({...editData, address: e.target.value}) })),
                                        React.createElement("td", { className: "p-2 text-right flex justify-end gap-2" },
                                            React.createElement("button", { onClick: saveEdit, className: "p-1 bg-green-500 text-white rounded" }, React.createElement(CheckCircle, { size: 16 })),
                                            React.createElement("button", { onClick: () => setEditingId(null), className: "p-1 bg-red-400 text-white rounded" }, React.createElement(X, { size: 16 }))
                                        )
                                    ) :
                                    React.createElement("tr", { key: c.id, className: "border-b hover:bg-slate-50" },
                                        React.createElement("td", { className: "p-3 font-bold" }, c.name),
                                        React.createElement("td", { className: "p-3" }, c.address),
                                        React.createElement("td", { className: "p-3 text-right flex justify-end gap-2" },
                                            React.createElement("button", { onClick: () => startEdit(c), className: "text-blue-500 hover:text-blue-700" }, React.createElement(Pencil, { size: 16 })),
                                            React.createElement("button", { onClick: () => deleteCustomer(c.id), className: "text-red-400 hover:text-red-600" }, React.createElement(Trash2, { size: 16 }))
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        const MasterTransporterForm = ({ user }) => {
            const [formData, setFormData] = useState({ name: '', address: '', phone: '' });
            const [transporters, setTransporters] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [editData, setEditData] = useState({});

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'transporters'));
                const unsub = onSnapshot(q, s => setTransporters(s.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => unsub();
            }, [user]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transporters'), { ...formData, createdAt: serverTimestamp() });
                setFormData({ name: '', address: '', phone: '' });
            };

            const startEdit = (t) => {
                setEditingId(t.id);
                setEditData(t);
            };

            const saveEdit = async () => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transporters', editingId), {
                        name: editData.name,
                        address: editData.address,
                        phone: editData.phone
                    });
                    setEditingId(null);
                } catch (err) {
                    console.error("Gagal update transporter:", err);
                    alert("Gagal update data");
                }
            };

            const deleteTransporter = async (id) => {
                if(confirm("Hapus transporter ini?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transporters', id));
                }
            };

            return React.createElement("div", { className: "space-y-6 no-print" },
                React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border" },
                    React.createElement("h2", { className: "font-bold mb-4 flex gap-2 items-center" }, React.createElement(Briefcase, { className: "text-blue-500" }), " Data Transporter"),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-3" },
                        React.createElement("input", { required: true, placeholder: "Nama Transporter / PT", className: "w-full p-2 border rounded-lg", value: formData.name, onChange: e => setFormData({...formData, name: e.target.value}) }),
                        React.createElement("input", { placeholder: "Kontak / No. Telepon", className: "w-full p-2 border rounded-lg", value: formData.phone, onChange: e => setFormData({...formData, phone: e.target.value}) }),
                        React.createElement("textarea", { placeholder: "Alamat Lengkap", className: "w-full p-2 border rounded-lg", value: formData.address, onChange: e => setFormData({...formData, address: e.target.value}) }),
                        React.createElement("button", { className: "w-full bg-slate-800 text-white p-2 rounded-lg font-bold hover:bg-black transition-colors" }, "Simpan Transporter")
                    )
                ),
                React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border shadow-sm" },
                    React.createElement("h3", { className: "font-bold mb-4" }, "Daftar Transporter"),
                    React.createElement("div", { className: "overflow-x-auto" },
                        React.createElement("table", { className: "w-full text-sm text-left whitespace-nowrap" },
                            React.createElement("thead", { className: "bg-slate-50 text-slate-500 uppercase font-bold" },
                                React.createElement("tr", null,
                                    React.createElement("th", { className: "p-3" }, "Nama"),
                                    React.createElement("th", { className: "p-3" }, "Kontak"),
                                    React.createElement("th", { className: "p-3" }, "Alamat"),
                                    React.createElement("th", { className: "p-3 text-right" }, "Aksi")
                                )
                            ),
                            React.createElement("tbody", null,
                                transporters.length === 0 ? 
                                React.createElement("tr", null, React.createElement("td", { colSpan: 4, className: "p-4 text-center text-slate-400" }, "Belum ada transporter.")) :
                                transporters.map(t => 
                                    editingId === t.id ?
                                    React.createElement("tr", { key: t.id, className: "border-b bg-blue-50" },
                                        React.createElement("td", { className: "p-2" }, React.createElement("input", { className: "w-full p-1 border rounded", value: editData.name, onChange: e => setEditData({...editData, name: e.target.value}) })),
                                        React.createElement("td", { className: "p-2" }, React.createElement("input", { className: "w-full p-1 border rounded", value: editData.phone, onChange: e => setEditData({...editData, phone: e.target.value}) })),
                                        React.createElement("td", { className: "p-2" }, React.createElement("input", { className: "w-full p-1 border rounded", value: editData.address, onChange: e => setEditData({...editData, address: e.target.value}) })),
                                        React.createElement("td", { className: "p-2 text-right flex justify-end gap-2" },
                                            React.createElement("button", { onClick: saveEdit, className: "p-1 bg-green-500 text-white rounded" }, React.createElement(CheckCircle, { size: 16 })),
                                            React.createElement("button", { onClick: () => setEditingId(null), className: "p-1 bg-red-400 text-white rounded" }, React.createElement(X, { size: 16 }))
                                        )
                                    ) :
                                    React.createElement("tr", { key: t.id, className: "border-b hover:bg-slate-50" },
                                        React.createElement("td", { className: "p-3 font-bold" }, t.name),
                                        React.createElement("td", { className: "p-3" }, t.phone),
                                        React.createElement("td", { className: "p-3" }, t.address),
                                        React.createElement("td", { className: "p-3 text-right flex justify-end gap-2" },
                                            React.createElement("button", { onClick: () => startEdit(t), className: "text-blue-500 hover:text-blue-700" }, React.createElement(Pencil, { size: 16 })),
                                            React.createElement("button", { onClick: () => deleteTransporter(t.id), className: "text-red-400 hover:text-red-600" }, React.createElement(Trash2, { size: 16 }))
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        const MasterItemForm = ({ user }) => {
            const [formData, setFormData] = useState({ name: '', uom: 'PCS', notes: '' });
            const [items, setItems] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [editData, setEditData] = useState({});

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'items'));
                const unsub = onSnapshot(q, s => setItems(s.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => unsub();
            }, [user]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'items'), { ...formData, createdAt: serverTimestamp() });
                setFormData({ name: '', uom: 'PCS', notes: '' });
            };

            const startEdit = (item) => {
                const password = prompt("Masukkan Password Admin untuk Edit Barang:");
                if (password !== 'admin123') {
                    alert("Password Salah! Akses ditolak.");
                    return;
                }
                setEditingId(item.id);
                setEditData(item);
            };

            const saveEdit = async () => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', editingId), {
                        name: editData.name,
                        uom: editData.uom,
                        notes: editData.notes || '' 
                    });
                    setEditingId(null);
                } catch (err) {
                    console.error("Gagal update barang:", err);
                    alert("Gagal update data");
                }
            };

            const deleteItem = async (id) => {
                const password = prompt("Masukkan Password Admin untuk Hapus Barang:");
                if (password !== 'admin123') {
                    alert("Password Salah! Akses ditolak.");
                    return;
                }

                if(confirm("Hapus barang ini?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', id));
                }
            };

            return React.createElement("div", { className: "space-y-6 no-print" },
                React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border" },
                    React.createElement("h2", { className: "font-bold mb-4 flex gap-2 items-center" }, React.createElement(Package, { className: "text-blue-500" }), " Data Barang Dagangan"),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-3" },
                        React.createElement("input", { required: true, placeholder: "Nama Barang", className: "w-full p-2 border rounded-lg", value: formData.name, onChange: e => setFormData({...formData, name: e.target.value}) }),
                        React.createElement("input", { required: true, placeholder: "Satuan Dasar (PCS/KG/Ltr)", className: "w-full p-2 border rounded-lg", value: formData.uom, onChange: e => setFormData({...formData, uom: e.target.value}) }),
                        React.createElement("textarea", { placeholder: "Keterangan Default (Opsional)", className: "w-full p-2 border rounded-lg", value: formData.notes, onChange: e => setFormData({...formData, notes: e.target.value}) }), 
                        React.createElement("button", { className: "w-full bg-slate-800 text-white p-2 rounded-lg font-bold hover:bg-black transition-colors" }, "Simpan Barang")
                    )
                ),
                React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border shadow-sm" },
                    React.createElement("h3", { className: "font-bold mb-4" }, "Daftar Barang"),
                    React.createElement("div", { className: "overflow-x-auto" },
                        React.createElement("table", { className: "w-full text-sm text-left whitespace-nowrap" },
                            React.createElement("thead", { className: "bg-slate-50 text-slate-500 uppercase font-bold" },
                                React.createElement("tr", null,
                                    React.createElement("th", { className: "p-3" }, "Nama Barang"),
                                    React.createElement("th", { className: "p-3" }, "Satuan"),
                                    React.createElement("th", { className: "p-3" }, "Keterangan"), 
                                    React.createElement("th", { className: "p-3 text-right" }, "Aksi")
                                )
                            ),
                            React.createElement("tbody", null,
                                items.length === 0 ? 
                                React.createElement("tr", null, React.createElement("td", { colSpan: 4, className: "p-4 text-center text-slate-400" }, "Belum ada barang.")) :
                                items.map(i => 
                                    editingId === i.id ?
                                    React.createElement("tr", { key: i.id, className: "border-b bg-blue-50" },
                                        React.createElement("td", { className: "p-2" }, React.createElement("input", { className: "w-full p-1 border rounded", value: editData.name, onChange: e => setEditData({...editData, name: e.target.value}) })),
                                        React.createElement("td", { className: "p-2" }, React.createElement("input", { className: "w-full p-1 border rounded", value: editData.uom, onChange: e => setEditData({...editData, uom: e.target.value}) })),
                                        React.createElement("td", { className: "p-2" }, React.createElement("input", { className: "w-full p-1 border rounded", value: editData.notes, onChange: e => setEditData({...editData, notes: e.target.value}) })), 
                                        React.createElement("td", { className: "p-2 text-right flex justify-end gap-2" },
                                            React.createElement("button", { onClick: saveEdit, className: "p-1 bg-green-500 text-white rounded" }, React.createElement(CheckCircle, { size: 16 })),
                                            React.createElement("button", { onClick: () => setEditingId(null), className: "p-1 bg-red-400 text-white rounded" }, React.createElement(X, { size: 16 }))
                                        )
                                    ) :
                                    React.createElement("tr", { key: i.id, className: "border-b hover:bg-slate-50" },
                                        React.createElement("td", { className: "p-3 font-bold" }, i.name),
                                        React.createElement("td", { className: "p-3" }, i.uom),
                                        React.createElement("td", { className: "p-3 italic text-slate-500" }, i.notes || '-'), 
                                        React.createElement("td", { className: "p-3 text-right flex justify-end gap-2" },
                                            React.createElement("button", { onClick: () => startEdit(i), className: "text-blue-500 hover:text-blue-700" }, React.createElement(Pencil, { size: 16 })),
                                            React.createElement("button", { onClick: () => deleteItem(i.id), className: "text-red-400 hover:text-red-600" }, React.createElement(Trash2, { size: 16 }))
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        const RegisterTruckForm = ({ user, trucks }) => {
            const [formData, setFormData] = useState({ 
                nopol: '', 
                driver: '', 
                noHp: '', 
                type: 'CDD',
                ticketNumber: '', // NEW
                netWeight: ''     // NEW
            });
            const [editingId, setEditingId] = useState(null);
            const [editData, setEditData] = useState({});

            const handleSubmit = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'trucks'), { 
                    ...formData, 
                    nopol: formData.nopol.toUpperCase(), 
                    createdAt: serverTimestamp() 
                });
                setFormData({ nopol: '', driver: '', noHp: '', type: 'CDD', ticketNumber: '', netWeight: '' });
            };

            const startEdit = (truck) => {
                const password = prompt("Masukkan Password Admin untuk Edit Armada:");
                // Untuk Transporter, kita anggap mereka tahu password ini atau kita bypass, 
                // tapi demi keamanan standard di kode ini saya biarkan check password admin. 
                // Jika ingin transporter bisa edit tanpa pass, hapus blok if ini.
                if (password !== 'admin123') {
                    alert("Password Salah! Akses ditolak.");
                    return;
                }
                setEditingId(truck.id);
                setEditData(truck);
            };

            const cancelEdit = () => {
                setEditingId(null);
                setEditData({});
            };

            const saveEdit = async () => {
                if(!editData.nopol || !editData.driver) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trucks', editingId), {
                        nopol: editData.nopol.toUpperCase(),
                        driver: editData.driver,
                        noHp: editData.noHp,
                        type: editData.type,
                        ticketNumber: editData.ticketNumber || '', // UPDATE
                        netWeight: editData.netWeight || ''       // UPDATE
                    });
                    setEditingId(null);
                } catch (err) {
                    console.error("Gagal update:", err);
                    alert("Gagal update data");
                }
            };

            const deleteTruck = async (id) => {
                const password = prompt("Masukkan Password Admin untuk Hapus Armada:");
                if (password !== 'admin123') {
                    alert("Password Salah! Akses ditolak.");
                    return;
                }

                if(confirm("Yakin hapus armada ini?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trucks', id));
                }
            };

            return React.createElement("div", { className: "space-y-6 no-print" },
                React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border shadow-sm" },
                    React.createElement("h2", { className: "font-bold mb-4 flex gap-2 items-center" }, React.createElement(PlusCircle, { className: "text-blue-500" }), " Registrasi Armada Pengiriman"),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-3" },
                        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
                            React.createElement("input", { required: true, placeholder: "No Polisi (Contoh: B 1234 XX)", className: "w-full p-2 border rounded-lg uppercase", value: formData.nopol, onChange: e => setFormData({...formData, nopol: e.target.value}) }),
                            React.createElement("select", { className: "w-full p-2 border rounded-lg", value: formData.type, onChange: e => setFormData({...formData, type: e.target.value}) }, 
                                TRUCK_TYPES.map(t => React.createElement("option", { key: t, value: t }, t))
                            )
                        ),
                        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
                            React.createElement("input", { required: true, placeholder: "Nama Driver", className: "w-full p-2 border rounded-lg", value: formData.driver, onChange: e => setFormData({...formData, driver: e.target.value}) }),
                            React.createElement("input", { type: "tel", placeholder: "No HP Driver", className: "w-full p-2 border rounded-lg", value: formData.noHp, onChange: e => setFormData({...formData, noHp: e.target.value}) })
                        ),
                        
                        // NEW INPUT FIELDS
                        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3 pt-2 border-t" },
                            React.createElement("div", { className: "relative" },
                                React.createElement(Receipt, { className: "absolute left-3 top-3 text-slate-400", size: 18 }),
                                React.createElement("input", { 
                                    placeholder: "No Tiket Timbangan", 
                                    className: "w-full p-2 pl-10 border rounded-lg bg-yellow-50", 
                                    value: formData.ticketNumber, 
                                    onChange: e => setFormData({...formData, ticketNumber: e.target.value}) 
                                })
                            ),
                            React.createElement("div", { className: "relative" },
                                React.createElement(Scale, { className: "absolute left-3 top-3 text-slate-400", size: 18 }),
                                React.createElement("input", { 
                                    type: "number",
                                    placeholder: "Qty Net Timbangan (Kg)", 
                                    className: "w-full p-2 pl-10 border rounded-lg bg-yellow-50", 
                                    value: formData.netWeight, 
                                    onChange: e => setFormData({...formData, netWeight: e.target.value}) 
                                })
                            )
                        ),

                        React.createElement("button", { className: "w-full bg-blue-600 text-white p-2 rounded-lg font-bold hover:bg-blue-700 transition-colors" }, "Simpan Armada")
                    )
                ),

                React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border shadow-sm" },
                    React.createElement("h2", { className: "font-bold mb-4 flex gap-2 items-center" }, React.createElement(Truck, { className: "text-blue-500" }), " Daftar Armada"),
                    React.createElement("div", { className: "overflow-x-auto" },
                        React.createElement("table", { className: "w-full text-sm text-left whitespace-nowrap" },
                            React.createElement("thead", { className: "bg-slate-50 text-slate-500 uppercase font-bold" },
                                React.createElement("tr", null,
                                    React.createElement("th", { className: "p-3" }, "No Polisi"),
                                    React.createElement("th", { className: "p-3" }, "Driver"),
                                    React.createElement("th", { className: "p-3" }, "No Tiket"), // NEW
                                    React.createElement("th", { className: "p-3" }, "Netto (Kg)"), // NEW
                                    React.createElement("th", { className: "p-3" }, "Tipe"),
                                    React.createElement("th", { className: "p-3 text-right" }, "Aksi")
                                )
                            ),
                            React.createElement("tbody", null,
                                trucks.length === 0 ? 
                                React.createElement("tr", null, React.createElement("td", { colSpan: 7, className: "p-4 text-center text-slate-400" }, "Belum ada armada terdaftar.")) :
                                trucks.map(t => 
                                    editingId === t.id ? 
                                    React.createElement("tr", { key: t.id, className: "border-b bg-blue-50" },
                                        React.createElement("td", { className: "p-2" }, 
                                            React.createElement("input", { className: "w-full p-1 border rounded uppercase font-bold", value: editData.nopol, onChange: e => setEditData({...editData, nopol: e.target.value}) })
                                        ),
                                        React.createElement("td", { className: "p-2" }, 
                                            React.createElement("input", { className: "w-full p-1 border rounded", value: editData.driver, onChange: e => setEditData({...editData, driver: e.target.value}) })
                                        ),
                                        // EDIT FIELDS
                                        React.createElement("td", { className: "p-2" }, 
                                            React.createElement("input", { className: "w-full p-1 border rounded", value: editData.ticketNumber, onChange: e => setEditData({...editData, ticketNumber: e.target.value}) })
                                        ),
                                        React.createElement("td", { className: "p-2" }, 
                                            React.createElement("input", { type:"number", className: "w-full p-1 border rounded", value: editData.netWeight, onChange: e => setEditData({...editData, netWeight: e.target.value}) })
                                        ),
                                        React.createElement("td", { className: "p-2" }, 
                                            React.createElement("select", { className: "w-full p-1 border rounded", value: editData.type, onChange: e => setEditData({...editData, type: e.target.value}) },
                                                TRUCK_TYPES.map(type => React.createElement("option", { key: type, value: type }, type))
                                            )
                                        ),
                                        React.createElement("td", { className: "p-2 text-right flex justify-end gap-2" }, 
                                            React.createElement("button", { onClick: saveEdit, className: "p-1 bg-green-500 text-white rounded hover:bg-green-600" }, React.createElement(CheckCircle, { size: 16 })),
                                            React.createElement("button", { onClick: cancelEdit, className: "p-1 bg-red-400 text-white rounded hover:bg-red-500" }, React.createElement(X, { size: 16 }))
                                        )
                                    ) :
                                    React.createElement("tr", { key: t.id, className: "border-b hover:bg-slate-50" },
                                        React.createElement("td", { className: "p-3 font-bold" }, t.nopol),
                                        React.createElement("td", { className: "p-3" }, t.driver),
                                        // DISPLAY FIELDS
                                        React.createElement("td", { className: "p-3 text-slate-600 font-mono text-xs" }, t.ticketNumber || '-'),
                                        React.createElement("td", { className: "p-3 font-bold text-blue-600" }, t.netWeight || '-'),
                                        
                                        React.createElement("td", { className: "p-3" }, 
                                            React.createElement("span", { className: "bg-slate-200 px-2 py-1 rounded text-xs font-bold" }, t.type)
                                        ),
                                        React.createElement("td", { className: "p-3 text-right flex justify-end gap-2" }, 
                                            React.createElement("button", { onClick: () => startEdit(t), className: "text-blue-500 hover:text-blue-700" }, React.createElement(Pencil, { size: 16 })),
                                            React.createElement("button", { onClick: () => deleteTruck(t.id), className: "text-red-400 hover:text-red-600" }, React.createElement(Trash2, { size: 16 }))
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        // SETTINGS PAGE
        const SettingsPage = ({ user }) => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [loginData, setLoginData] = useState({ username: '', password: '' });
            const [activeTab, setActiveTab] = useState('general');
            const [coords, setCoords] = useState(DEFAULT_COORDS);
            const [waConfig, setWaConfig] = useState({ token: '', targetGroups: '' });
            const [loading, setLoading] = useState(false);
            const [isResetting, setIsResetting] = useState(false);

            useEffect(() => {
                if (!user) return;
                const loadSettings = async () => {
                    const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'));
                    if (snap.exists()) {
                        const data = snap.data();
                        if(data.printConfig) setCoords(data.printConfig);
                        if(data.waConfig) setWaConfig(data.waConfig);
                    }
                };
                loadSettings();
            }, [user]);

            const handleLogin = (e) => {
                e.preventDefault();
                if (loginData.username === 'admin' && loginData.password === 'admin123') {
                    setIsAuthenticated(true);
                } else {
                    alert("Username atau Password salah!");
                }
            };

            const handleResetTransactions = async () => {
                if (!confirm("PERINGATAN KERAS:\nAnda akan menghapus SEMUA DATA RIWAYAT TRANSAKSI.\nData yang dihapus TIDAK BISA DIKEMBALIKAN.\n\nKlik OK jika Anda yakin.")) return;
                if (!confirm("Apakah Anda benar-benar yakin ingin mengosongkan data transaksi?")) return;

                setIsResetting(true);
                try {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'));
                    const snapshot = await getDocs(q); 
                    const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    alert("Semua data transaksi berhasil dihapus.");
                } catch (error) {
                    console.error("Error resetting transactions:", error);
                    alert("Gagal menghapus data: " + error.message);
                }
                setIsResetting(false);
            };

            const handleResetMasterData = async () => {
                 if (!confirm("PERINGATAN KERAS:\nAnda akan menghapus SEMUA DATA MASTER (Customer, Barang, Armada).\nAnda harus menginput ulang data dari awal.\n\nLanjutkan?")) return;
                 if (!confirm("Yakin hapus Master Data?")) return;

                 setIsResetting(true);
                 try {
                    const qC = query(collection(db, 'artifacts', appId, 'public', 'data', 'customers'));
                    const sC = await getDocs(qC);
                    const pC = sC.docs.map(d => deleteDoc(d.ref));

                    const qI = query(collection(db, 'artifacts', appId, 'public', 'data', 'items'));
                    const sI = await getDocs(qI);
                    const pI = sI.docs.map(d => deleteDoc(d.ref));

                    const qT = query(collection(db, 'artifacts', appId, 'public', 'data', 'trucks'));
                    const sT = await getDocs(qT);
                    const pT = sT.docs.map(d => deleteDoc(d.ref));

                    await Promise.all([...pC, ...pI, ...pT]);
                    alert("Semua master data berhasil dihapus.");
                 } catch (error) {
                     console.error(error);
                     alert("Gagal reset master data.");
                 }
                 setIsResetting(false);
            }

            if (!isAuthenticated) {
                return React.createElement("div", { className: "w-11/12 max-w-md mx-auto mt-10 bg-white p-6 md:p-8 rounded-xl border shadow-sm" },
                    React.createElement("h2", { className: "text-xl font-bold text-center mb-6 flex items-center justify-center gap-2" }, 
                        React.createElement(Settings, { className: "text-blue-500" }), "Akses Pengaturan"
                    ),
                    React.createElement("form", { onSubmit: handleLogin, className: "space-y-4" },
                        React.createElement("div", null,
                            React.createElement("label", { className: "block text-sm font-bold text-slate-500 mb-1" }, "Username"),
                            React.createElement("input", { 
                                type: "text", 
                                className: "w-full p-2 border rounded-lg",
                                value: loginData.username,
                                onChange: e => setLoginData({...loginData, username: e.target.value})
                            })
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { className: "block text-sm font-bold text-slate-500 mb-1" }, "Password"),
                            React.createElement("input", { 
                                type: "password", 
                                className: "w-full p-2 border rounded-lg",
                                value: loginData.password,
                                onChange: e => setLoginData({...loginData, password: e.target.value})
                            })
                        ),
                        React.createElement("button", { className: "w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700" }, "Masuk")
                    )
                );
            }

            const saveSettings = async () => {
                setLoading(true);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), {
                        printConfig: coords,
                        waConfig: waConfig,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    alert("Pengaturan Berhasil Disimpan!");
                } catch (err) {
                    console.error(err);
                    alert("Gagal menyimpan");
                }
                setLoading(false);
            };

            return React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border shadow-sm no-print space-y-6" },
                React.createElement("h2", { className: "text-lg font-bold flex items-center gap-2 border-b pb-4" }, 
                    React.createElement(Settings, { className: "text-blue-500" }), " Pengaturan Aplikasi"
                ),
                
                React.createElement("div", { className: "flex gap-2 border-b overflow-x-auto hide-scrollbar" },
                    React.createElement("button", { onClick: () => setActiveTab('general'), className: `px-4 py-2 border-b-2 font-bold whitespace-nowrap ${activeTab === 'general' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-400'}` }, "Umum"),
                    React.createElement("button", { onClick: () => setActiveTab('wa'), className: `px-4 py-2 border-b-2 font-bold whitespace-nowrap ${activeTab === 'wa' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-400'}` }, "WhatsApp"),
                    React.createElement("button", { onClick: () => setActiveTab('print'), className: `px-4 py-2 border-b-2 font-bold whitespace-nowrap ${activeTab === 'print' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-400'}` }, "Kalibrasi Cetak"),
                    React.createElement("button", { onClick: () => setActiveTab('reset'), className: `px-4 py-2 border-b-2 font-bold whitespace-nowrap ${activeTab === 'reset' ? 'border-red-500 text-red-600' : 'border-transparent text-slate-400'}` }, "Reset Data")
                ),

                activeTab === 'general' && React.createElement("div", { className: "text-center py-8" },
                    React.createElement(TrendingUp, { className: "text-blue-200 mx-auto mb-4", size: 48 }),
                    React.createElement("h3", {className: "font-bold text-lg"}, "My Trading v1.2"),
                    React.createElement("p", { className: "text-slate-500 text-sm" }, "Sistem Manajemen Transaksi & Logistik Terpadu")
                ),

                activeTab === 'wa' && React.createElement("div", { className: "space-y-4" },
                    React.createElement("div", { className: "bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-xs text-yellow-800" }, 
                        "Sistem menggunakan API Fonnte untuk mengirim notifikasi WhatsApp. Pastikan token aktif."
                    ),
                    React.createElement("div", null,
                        React.createElement("label", { className: "block text-xs font-bold text-slate-500 mb-1" }, "TOKEN FONNTE"),
                        React.createElement("input", { 
                            type: "text", 
                            placeholder: "Masukkan Token Fonnte...", 
                            className: "w-full p-2 border rounded-lg",
                            value: waConfig.token,
                            onChange: e => setWaConfig({...waConfig, token: e.target.value})
                        })
                    ),
                    React.createElement("div", null,
                        React.createElement("label", { className: "block text-xs font-bold text-slate-500 mb-1" }, "ID GROUP WHATSAPP (Pisahkan koma jika > 1)"),
                        React.createElement("input", { 
                            type: "text", 
                            placeholder: "1203630234@g.us, 1203630999@g.us", 
                            className: "w-full p-2 border rounded-lg",
                            value: waConfig.targetGroups,
                            onChange: e => setWaConfig({...waConfig, targetGroups: e.target.value})
                        })
                    ),
                    React.createElement("button", { onClick: saveSettings, disabled: loading, className: "bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 w-full md:w-auto" }, 
                        loading ? "Menyimpan..." : "Simpan Konfigurasi WA"
                    )
                ),

                activeTab === 'print' && React.createElement("div", { className: "space-y-4" },
                    React.createElement("p", { className: "text-sm text-slate-500" }, "Atur koordinat (dalam milimeter) untuk posisi cetak pada blangko kosong."),
                    React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                        Object.entries(coords).map(([key, val]) => 
                            React.createElement("div", { key: key, className: "border p-3 rounded-lg bg-slate-50" },
                                React.createElement("p", { className: "font-bold text-sm mb-2" }, val.label),
                                React.createElement("div", { className: "flex gap-2" },
                                    React.createElement("div", { className: "flex-1" },
                                        React.createElement("label", { className: "text-[10px] text-slate-400 block" }, "ATAS (Y) mm"),
                                        React.createElement("input", { 
                                            type: "number", 
                                            className: "w-full p-1 border rounded", 
                                            value: val.top,
                                            onChange: e => setCoords({ ...coords, [key]: { ...val, top: Number(e.target.value) } })
                                        })
                                    ),
                                    React.createElement("div", { className: "flex-1" },
                                        React.createElement("label", { className: "text-[10px] text-slate-400 block" }, "KIRI (X) mm"),
                                        React.createElement("input", { 
                                            type: "number", 
                                            className: "w-full p-1 border rounded", 
                                            value: val.left,
                                            onChange: e => setCoords({ ...coords, [key]: { ...val, left: Number(e.target.value) } })
                                        })
                                    )
                                )
                            )
                        )
                    ),
                    React.createElement("button", { onClick: saveSettings, disabled: loading, className: "bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 mt-4 w-full md:w-auto" }, 
                        loading ? "Menyimpan..." : "Simpan Koordinat"
                    )
                ),

                // RESET DATA TAB
                activeTab === 'reset' && React.createElement("div", { className: "space-y-6" },
                    React.createElement("div", { className: "bg-red-50 border border-red-200 p-4 rounded-lg flex gap-3 items-start" },
                        React.createElement(AlertTriangle, { className: "text-red-600 shrink-0 mt-1" }),
                        React.createElement("div", null,
                            React.createElement("h3", { className: "font-bold text-red-800" }, "Zona Bahaya (Danger Zone)"),
                            React.createElement("p", { className: "text-sm text-red-700 mt-1" }, 
                                "Tindakan di halaman ini bersifat destruktif dan tidak dapat dibatalkan. Data yang dihapus akan hilang selamanya."
                            )
                        )
                    ),

                    React.createElement("div", { className: "space-y-4" },
                        React.createElement("div", { className: "border p-4 rounded-lg flex flex-col md:flex-row justify-between items-center gap-4 bg-white" },
                            React.createElement("div", null,
                                React.createElement("h4", { className: "font-bold" }, "Reset Data Transaksi"),
                                React.createElement("p", { className: "text-xs text-slate-500" }, "Menghapus semua riwayat transaksi pengiriman. Data Customer, Barang, & Armada TETAP ADA.")
                            ),
                            React.createElement("button", { 
                                onClick: handleResetTransactions, 
                                disabled: isResetting,
                                className: "bg-red-100 text-red-700 px-4 py-2 rounded-lg font-bold hover:bg-red-200 border border-red-200 whitespace-nowrap disabled:opacity-50" 
                            }, isResetting ? "Memproses..." : "Hapus Semua Transaksi")
                        ),

                        React.createElement("div", { className: "border p-4 rounded-lg flex flex-col md:flex-row justify-between items-center gap-4 bg-white" },
                            React.createElement("div", null,
                                React.createElement("h4", { className: "font-bold" }, "Reset Master Data (Total Reset)"),
                                React.createElement("p", { className: "text-xs text-slate-500" }, "Menghapus Customer, Barang, dan Armada. Aplikasi akan menjadi kosong melompong.")
                            ),
                            React.createElement("button", { 
                                onClick: handleResetMasterData, 
                                disabled: isResetting,
                                className: "bg-slate-100 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-200 border border-slate-300 whitespace-nowrap disabled:opacity-50" 
                            }, isResetting ? "Memproses..." : "Hapus Master Data")
                        )
                    )
                )
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState(null); // 'admin' atau 'transporter'
            const [view, setView] = useState('transaction'); 
            const [loading, setLoading] = useState(true);
            const [trucks, setTrucks] = useState([]); 

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth error:", error);
                    }
                };
                initAuth();
                
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const qT = query(collection(db, 'artifacts', appId, 'public', 'data', 'trucks'));
                const unsub = onSnapshot(qT, s => setTrucks(s.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => unsub();
            }, [user]);

            // Jika belum login ke "App Role", tampilkan login screen
            if (!userRole) {
                return React.createElement(LoginScreen, { 
                    onLogin: (role) => {
                        setUserRole(role);
                        // Set view default berdasarkan role
                        setView(role === 'transporter' ? 'register' : 'transaction');
                    } 
                });
            }

            if (loading) return React.createElement('div', { className: "flex flex-col items-center justify-center h-screen bg-white" },
                React.createElement("div", { className: "relative flex items-center justify-center w-24 h-24 mb-8" },
                    React.createElement("div", { className: "absolute inset-0 border-4 border-blue-100 rounded-full" }),
                    React.createElement("div", { className: "absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin" }),
                    React.createElement(TrendingUp, { className: "text-blue-600", size: 32 })
                ),
                React.createElement("h2", { className: "text-2xl font-black text-slate-800 mb-2 tracking-tight" }, "MY TRADING"),
                React.createElement("p", { className: "text-slate-500 font-medium animate-pulse" }, "Pengalihan server Mytrading MyScm..."),
                React.createElement("div", { className: "mt-8 flex gap-2" },
                    [0,1,2].map(i => React.createElement("div", { key: i, className: "w-2 h-2 bg-blue-600 rounded-full animate-bounce", style: { animationDelay: `${i * 0.1}s` } }))
                )
            );

            // Konfigurasi Menu berdasarkan Role
            const allMenuItems = [
                {v: 'transaction', i: ClipboardList, l: 'Transaksi'},
                {v: 'history', i: History, l: 'Riwayat'},
                {v: 'recap', i: FileSpreadsheet, l: 'Rekap'}, 
                {v: 'register', i: Truck, l: 'Armada'},
                {v: 'customers', i: Users, l: 'Customer'},
                {v: 'transporters', i: Briefcase, l: 'Transporter'}, // NEW MENU
                {v: 'items', i: Package, l: 'Barang'},
                {v: 'instruction', i: Info, l: 'Panduan'}
            ];

            // Filter Menu: Jika Transporter, hanya ambil menu 'register' (Armada)
            const menuItems = userRole === 'transporter' 
                ? allMenuItems.filter(item => item.v === 'register')
                : allMenuItems;

            return (
                React.createElement("div", { className: "min-h-screen bg-slate-100 flex flex-col" },
                    React.createElement("header", { className: "bg-blue-800 text-white shadow-lg sticky top-0 z-20 no-print" },
                        React.createElement("div", { className: "max-w-6xl mx-auto px-4" },
                            React.createElement("div", { className: "flex items-center justify-between h-16" },
                                React.createElement("div", { className: "flex items-center gap-2 shrink-0" },
                                    React.createElement(TrendingUp, { size: 24 }),
                                    React.createElement("h1", { className: "text-lg font-bold hidden sm:block" }, "My Trading"),
                                    React.createElement("h1", { className: "text-lg font-bold sm:hidden" }, "MT"),
                                    userRole === 'transporter' && React.createElement("span", { className: "bg-orange-500 text-xs px-2 py-1 rounded ml-2" }, "Transporter")
                                ),
                                
                                React.createElement("div", { className: "flex-1 flex justify-start md:justify-center px-4 overflow-x-auto hide-scrollbar" },
                                    React.createElement("div", { className: "flex items-center gap-2 sm:gap-4" },
                                        menuItems.map(item => (
                                            React.createElement("button", { 
                                                key: item.v, 
                                                onClick: () => setView(item.v),
                                                className: `flex items-center gap-1.5 px-3 py-2 rounded-lg transition-all whitespace-nowrap text-sm ${view === item.v ? 'bg-blue-700 text-white shadow-inner' : 'text-blue-200 hover:text-white hover:bg-blue-700/50'}`
                                            }, 
                                                React.createElement(item.i, { size: 18 }),
                                                React.createElement("span", { className: "text-xs font-bold uppercase" }, item.l)
                                            )
                                        ))
                                    )
                                ),

                                React.createElement("div", { className: "flex items-center gap-2" },
                                    // Tombol Setting hanya untuk Admin
                                    userRole === 'admin' && React.createElement("button", { onClick: () => setView('settings'), className: `p-2 rounded-full transition-colors ${view === 'settings' ? 'bg-blue-700' : 'hover:bg-blue-700'}` }, 
                                        React.createElement(Settings, { size: 20 })
                                    ),
                                    // Tombol Logout
                                    React.createElement("button", { 
                                        onClick: () => { setUserRole(null); },
                                        className: "p-2 rounded-full hover:bg-red-600 transition-colors text-red-200 hover:text-white",
                                        title: "Keluar"
                                    }, 
                                        React.createElement(LogOut, { size: 20 })
                                    )
                                )
                            )
                        )
                    ),

                    React.createElement("main", { className: "max-w-4xl mx-auto p-2 md:p-4 md:pt-8 flex-1 w-full" },
                        view === 'register' && React.createElement(RegisterTruckForm, { user, trucks }),
                        
                        // Proteksi Tampilan: Hanya render menu lain jika Admin
                        userRole === 'admin' && view === 'customers' && React.createElement(MasterCustomerForm, { user }),
                        userRole === 'admin' && view === 'transporters' && React.createElement(MasterTransporterForm, { user }), // Render Transporter Form
                        userRole === 'admin' && view === 'items' && React.createElement(MasterItemForm, { user }),
                        userRole === 'admin' && view === 'transaction' && React.createElement(TransactionForm, { user, trucks }),
                        userRole === 'admin' && view === 'history' && React.createElement(TransactionHistory, { user }),
                        userRole === 'admin' && view === 'recap' && React.createElement(RecapPage, { user }),
                        userRole === 'admin' && view === 'instruction' && React.createElement(InstructionPage),
                        userRole === 'admin' && view === 'settings' && React.createElement(SettingsPage, { user })
                    ),

                    React.createElement("footer", { className: "bg-white border-t p-4 text-center text-slate-400 text-xs no-print mt-auto" },
                        React.createElement("p", null, ` ${new Date().getFullYear()} My Trading System. All rights reserved.`)
                    )
                )
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
