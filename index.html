<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Trading - Manajemen Transaksi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS untuk Export Excel Rapih -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f8fafc; /* Slate 50 - Very light grey background */
            overflow: hidden; /* Prevent body scroll, handle in app shell */
        }
        
        .font-print { font-family: 'Courier Prime', monospace; }

        /* Styles for New Transaction Form */
        .input-field { 
            display: block; 
            width: 100%; 
            border-radius: 0.5rem; /* Lebih rounded */
            border-width: 1px; 
            border-color: #e2e8f0; 
            background-color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
            padding: 0.625rem; 
            font-size: 0.875rem; 
            line-height: 1.25rem; 
            transition: all 0.2s;
        }
        .input-field:focus { 
            border-color: #38bdf8; /* Sky 400 */
            ring: 3px; 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
        }
        .label-text { 
            display: block; 
            font-size: 0.75rem; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600; 
            color: #64748b; /* Slate 500 */
            margin-bottom: 0.375rem;
        }

        /* Marquee Animation */
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee {
            display: inline-block;
            animation: marquee 15s linear infinite; /* Slower for professional look */
            white-space: nowrap;
        }

        @media print {
            body { background: white !important; overflow: auto !important; }
            .no-print { display: none !important; }
            .print-area { display: block !important; padding: 0; margin: 0; width: 100%; }
            @page { size: auto; margin: 0mm; }
            
            .spj-blanko-data {
                position: relative;
                width: 210mm; 
                height: 140mm; 
            }
        }

        .preview-modal {
            background-color: rgba(15, 23, 42, 0.6); /* Darker backdrop */
            backdrop-filter: blur(4px);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Mobile optimization */
        input, select, textarea {
            font-size: 16px !important;
        }
    </style>
</head>
<body class="text-slate-800">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Truck, ClipboardList, CheckCircle, PlusCircle, User, Phone, 
            Box, Search, History, Settings, Save, AlertCircle, Users, 
            Package, Printer, Calendar, FileText, X, Eye, AlignJustify, 
            TrendingUp, MessageSquare, Pencil, Trash2, FileSpreadsheet, Download, Send, Lock, Info, AlertTriangle, LogOut,
            Scale, Receipt, Database, Server, Briefcase, MapPin, Navigation, Cloud, UserPlus, Key, Menu
        } from 'lucide-react';
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, setDoc, getDoc, getDocs, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCDb-ofn2ELU6mXsFPgyhT1MVPLsUPKNhg",
            authDomain: "spj-mki.firebaseapp.com",
            projectId: "spj-mki",
            storageBucket: "spj-mki.firebasestorage.app",
            messagingSenderId: "424266024897",
            appId: "1:424266024897:web:0d0b32610352120a665140"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-trading-v1';

        const TRUCK_TYPES = ['CDD', 'TRONTON', 'DUMPTRUK', 'WINGBOX', 'KONTAINER', 'BOX', 'MOBIL PRIBADI'];

        // Default Coordinate Configuration (mm)
        const DEFAULT_COORDS = {
            date: { top: 35, left: 140, label: 'Tanggal' },
            nopol: { top: 42, left: 140, label: 'No Polisi' },
            customerName: { top: 52, left: 20, label: 'Nama Customer' },
            customerAddress: { top: 58, left: 20, label: 'Alamat Customer' },
            itemName: { top: 85, left: 15, label: 'Nama Barang' },
            qty: { top: 85, left: 100, label: 'Quantity' },
            uom: { top: 85, left: 130, label: 'Satuan' },
            notes: { top: 95, left: 15, label: 'Keterangan' },
            driver: { top: 125, left: 75, label: 'Nama Driver' }
        };

        // --- DEFINISI KOMPONEN ---

        // 1. HALAMAN LOGIN UTAMA
        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'), 
                        where('username', '==', username)
                    );
                    
                    const snapshot = await getDocs(q);
                    let userFound = null;

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.password === password) {
                            userFound = data;
                        }
                    });

                    if (userFound) {
                        onLogin(userFound); 
                    } else {
                        if (username === 'admin' && password === 'admin123') {
                            onLogin({ role: 'admin', username: 'admin' });
                        } else if (username === 'user' && password === 'user123') {
                            onLogin({ role: 'user', username: 'user' });
                        } else if (username === 'timbang' && password === 'timbang123') {
                            onLogin({ role: 'timbang', username: 'timbang' });
                        } else {
                            setError('Username atau Password salah!');
                        }
                    }
                } catch (err) {
                    console.error("Login Error:", err);
                    if (username === 'admin' && password === 'admin123') {
                        onLogin({ role: 'admin', username: 'admin' });
                    } else {
                        setError('Terjadi kesalahan koneksi.');
                    }
                }
                setLoading(false);
            };

            return React.createElement("div", { className: "min-h-screen flex items-center justify-center bg-sky-50 p-4" },
                React.createElement("div", { className: "bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-sky-100" },
                    React.createElement("div", { className: "text-center mb-8" },
                        React.createElement("div", { className: "w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4" },
                            React.createElement(TrendingUp, { className: "text-green-600", size: 32, strokeWidth: 3 })
                        ),
                        React.createElement("h1", { className: "text-2xl font-bold text-[#B8860B] tracking-tight" }, "MyTrading"),
                        React.createElement("p", { className: "text-blue-600 text-sm font-medium" }, "Smart Trading Logistics Management")
                    ),
                    error && React.createElement("div", { className: "bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 text-center font-bold border border-red-100" }, error),
                    React.createElement("form", { onSubmit: handleLogin, className: "space-y-5" },
                        React.createElement("div", null,
                            React.createElement("label", { className: "block text-xs font-bold text-slate-400 mb-1 tracking-wider" }, "USERNAME"),
                            React.createElement("input", { 
                                type: "text", 
                                className: "w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:border-sky-400 focus:ring-4 focus:ring-sky-100 outline-none transition-all",
                                value: username,
                                onChange: e => setUsername(e.target.value),
                                placeholder: "Masukkan username..."
                            })
                        ),
                        React.createElement("div", null,
                            React.createElement("label", { className: "block text-xs font-bold text-slate-400 mb-1 tracking-wider" }, "PASSWORD"),
                            React.createElement("input", { 
                                type: "password", 
                                className: "w-full p-3 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:border-sky-400 focus:ring-4 focus:ring-sky-100 outline-none transition-all",
                                value: password,
                                onChange: e => setPassword(e.target.value),
                                placeholder: "Masukkan password..."
                            })
                        ),
                        React.createElement("button", { 
                            type: "submit",
                            disabled: loading,
                            className: "w-full bg-sky-600 text-white font-bold py-3.5 rounded-xl hover:bg-sky-700 transition-all active:scale-95 shadow-lg shadow-sky-200 hover:shadow-sky-300 disabled:opacity-70"
                        }, loading ? "Memeriksa..." : "MASUK SISTEM"),
                        React.createElement("div", { className: "text-center mt-6 text-xs text-slate-400 font-medium" },
                           "Versi 1.4.3 - MyTrading"
                        )
                    )
                )
            );
        };

        // 2. LIVE TRACKING PAGE
        const LiveTrackingPage = ({ user }) => {
            const [transactions, setTransactions] = useState([]);

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'));
                const unsub = onSnapshot(q, s => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    // Tampilkan transaksi aktif saja (ACTIVE)
                    setTransactions(data.filter(t => t.status === 'ACTIVE').sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0)).slice(0, 5));
                });
                return () => unsub();
            }, [user]);

            return React.createElement("div", { className: "space-y-6" }, 
                // Header & Stats
                React.createElement("div", { className: "bg-white p-6 rounded-xl border border-slate-100 shadow-sm" },
                    React.createElement("div", { className: "flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4" },
                        React.createElement("h2", { className: "text-xl font-bold flex items-center gap-2 text-slate-800" },
                            React.createElement(MapPin, { className: "text-sky-500" }), " Live Tracking TMS"
                        ),
                        // TULISAN BERJALAN (MARQUEE)
                        React.createElement("div", { className: "relative w-full md:w-96 h-8 bg-red-50 rounded-full border border-red-100 overflow-hidden flex items-center px-4" },
                            React.createElement("div", { className: "absolute inset-0 flex items-center" },
                                React.createElement("span", { className: "animate-marquee text-[11px] font-bold text-red-500 uppercase tracking-wider" }, 
                                    "⚠️ SYSTEM TERPUTUS DENGAN SERVER TRADING  —  MOHON HUBUNGI ADMIN JIKA TERDAPAT KENDALA DATA  —  GPS SIGNAL WEAK IN SOME AREAS"
                                )
                            )
                        )
                    ),
                    
                    // GOOGLE MAPS EMBED
                    React.createElement("div", { className: "aspect-video bg-slate-100 rounded-xl overflow-hidden border border-slate-200 shadow-inner relative" },
                        React.createElement("iframe", {
                            src: "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d126920.24097834448!2d106.75947813639148!3d-6.229746487930822!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x2e69f3e945e34b9d%3A0x5371bf0fdad786a2!2sJakarta%2C%20Special%20Capital%20Region%20of%20Jakarta!5e0!3m2!1sen!2sid!4v1708500000000!5m2!1sen!2sid",
                            width: "100%",
                            height: "100%",
                            style: { border: 0 },
                            allowFullScreen: "",
                            loading: "lazy",
                            referrerPolicy: "no-referrer-when-downgrade"
                        }),
                        React.createElement("div", { className: "absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-3 py-1.5 rounded-full text-xs font-bold shadow-sm border border-slate-100 flex items-center gap-2 text-slate-600" },
                            React.createElement("div", { className: "w-2 h-2 bg-green-500 rounded-full animate-ping" }),
                            "Realtime Traffic"
                        )
                    ),

                    // Stats Grid
                    React.createElement("div", { className: "mt-6 grid grid-cols-1 md:grid-cols-3 gap-4" },
                        React.createElement("div", { className: "p-5 bg-sky-50 rounded-xl border border-sky-100 flex flex-col justify-between" },
                            React.createElement("div", { className: "flex items-center gap-2 mb-2" },
                                React.createElement("div", { className: "p-2 bg-sky-100 rounded-lg" },
                                    React.createElement(Truck, { size: 18, className: "text-sky-600" })
                                ),
                                React.createElement("h3", { className: "text-xs text-sky-700 font-bold uppercase tracking-wider" }, "Total Unit Jalan")
                            ),
                            React.createElement("p", { className: "text-3xl font-black text-slate-800" }, transactions.length > 0 ? transactions.length : "0")
                        ),
                        React.createElement("div", { className: "p-5 bg-emerald-50 rounded-xl border border-emerald-100 flex flex-col justify-between" },
                            React.createElement("div", { className: "flex items-center gap-2 mb-2" },
                                React.createElement("div", { className: "p-2 bg-emerald-100 rounded-lg" },
                                    React.createElement(CheckCircle, { size: 18, className: "text-emerald-600" })
                                ),
                                React.createElement("h3", { className: "text-xs text-emerald-700 font-bold uppercase tracking-wider" }, "Terkirim (Hari Ini)")
                            ),
                            React.createElement("p", { className: "text-3xl font-black text-slate-800" }, "8")
                        ),
                        React.createElement("div", { className: "p-5 bg-amber-50 rounded-xl border border-amber-100 flex flex-col justify-between" },
                             React.createElement("div", { className: "flex items-center gap-2 mb-2" },
                                React.createElement("div", { className: "p-2 bg-amber-100 rounded-lg" },
                                    React.createElement(Navigation, { size: 18, className: "text-amber-600" })
                                ),
                                React.createElement("h3", { className: "text-xs text-amber-700 font-bold uppercase tracking-wider" }, "Sedang Transit")
                            ),
                            React.createElement("p", { className: "text-3xl font-black text-slate-800" }, "3")
                        )
                    )
                ),

                // Active List
                React.createElement("div", { className: "bg-white p-6 rounded-xl border border-slate-100 shadow-sm" },
                    React.createElement("h3", { className: "font-bold mb-6 flex items-center gap-2 text-slate-700" },
                         React.createElement(Truck, { size: 20, className: "text-sky-500" }), "Status Pengiriman Aktif"
                    ),
                    React.createElement("div", { className: "space-y-4" },
                        transactions.length === 0 ? 
                        React.createElement("div", { className: "text-center py-10 border-2 border-dashed border-slate-100 rounded-xl bg-slate-50" },
                            React.createElement(Truck, { className: "mx-auto text-slate-300 mb-2", size: 32 }),
                            React.createElement("p", { className: "text-slate-400 font-medium" }, "Tidak ada armada yang sedang berjalan.")
                        ) :
                        transactions.map((t, idx) => {
                            const isCompleted = t.status === 'COMPLETED';
                            return React.createElement("div", { key: t.id, className: "flex items-start gap-4 p-5 border border-slate-100 rounded-xl hover:bg-sky-50/30 hover:border-sky-100 transition-all shadow-sm" },
                                React.createElement("div", { className: "w-12 h-12 rounded-full bg-sky-100 flex items-center justify-center shrink-0 border border-sky-200" },
                                    React.createElement(Truck, { size: 24, className: "text-sky-600" })
                                ),
                                React.createElement("div", { className: "flex-1" },
                                    React.createElement("div", { className: "flex justify-between items-start" },
                                        React.createElement("div", null, 
                                            React.createElement("h4", { className: "font-bold text-slate-800" }, t.no_sj),
                                            React.createElement("p", { className: "text-xs text-slate-500 mt-0.5" }, 
                                                React.createElement("span", { className: "font-bold text-slate-700 bg-slate-100 px-1.5 py-0.5 rounded" }, t.nopol), " • ", t.driver
                                            )
                                        ),
                                        React.createElement("span", { className: `text-[10px] font-bold px-2.5 py-1 rounded-full border ${isCompleted ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-sky-50 border-sky-200 text-sky-700'}` }, isCompleted ? "SELESAI" : "OTW")
                                    ),
                                    React.createElement("p", { className: "text-sm font-semibold text-slate-700 mt-2 mb-3" }, 
                                        "Tujuan: ", t.customerName || "Customer Umum"
                                    ),
                                    // Progress Bar
                                    React.createElement("div", { className: "w-full bg-slate-100 rounded-full h-2 overflow-hidden" },
                                        React.createElement("div", { className: `h-full rounded-full transition-all duration-1000 ${isCompleted ? 'bg-emerald-500' : 'bg-sky-500'}`, style: { width: isCompleted ? '100%' : `${Math.floor(Math.random() * 80) + 10}%` } })
                                    ),
                                    // Footer with EPOD
                                    React.createElement("div", { className: "flex justify-between items-center mt-3 pt-3 border-t border-slate-100" },
                                        React.createElement("div", { className: "text-xs font-medium text-slate-400 flex items-center gap-1" },
                                            React.createElement(Navigation, { size: 12 }),
                                            React.createElement("span", null, isCompleted ? "Tiba di Lokasi" : "Est. Tiba 2 Jam")
                                        ),
                                        React.createElement("div", { className: `flex items-center gap-1.5 text-[10px] px-2.5 py-1 rounded-full border ${isCompleted ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-amber-50 border-amber-200 text-amber-700'}` },
                                            React.createElement(Receipt, { size: 12 }),
                                            React.createElement("span", { className: "font-bold" }, isCompleted ? "EPOD: Diterima" : "EPOD: Pending")
                                        )
                                    )
                                )
                            );
                        })
                    )
                )
            );
        };

        // 3. RECAP PAGE (Fixed: Changed 'date' to 'tanggal')
        const RecapPage = ({ user }) => {
            const [transactions, setTransactions] = useState([]);
            const [filter, setFilter] = useState({ 
                startDate: new Date().toISOString().split('T')[0], 
                endDate: new Date().toISOString().split('T')[0] 
            });
            const [editValues, setEditValues] = useState({});
            const [editStatusValues, setEditStatusValues] = useState({});

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'));
                const unsub = onSnapshot(q, s => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    // Perbaikan: Gunakan 'tanggal' untuk sorting karena data disimpan dengan key 'tanggal'
                    setTransactions(data.sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal)));
                });
                return () => unsub();
            }, [user]);

            const filteredData = transactions.filter(t => {
                // Perbaikan: Gunakan 't.tanggal' bukan 't.date'
                return t.tanggal >= filter.startDate && t.tanggal <= filter.endDate;
            });

            const handleSaveActual = async (id) => {
                const val = editValues[id];
                if (val === undefined || val === '') return;
                
                // AUTH CHECK & RETRY
                try {
                    if (!auth.currentUser) await signInAnonymously(auth);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id), { qtyActual: Number(val) });
                    setEditValues(prev => { const next = {...prev}; delete next[id]; return next; });
                    alert("Qty Actual berhasil disimpan!");
                } catch (err) { 
                    if(err.code === 'permission-denied') {
                        try { await signInAnonymously(auth); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id), { qtyActual: Number(val) }); alert("Berhasil disimpan!"); return; } catch(e){}
                    }
                    console.error("Error saving actual qty:", err); alert("Gagal menyimpan: " + err.message); 
                }
            };

            const handleSaveStatus = async (id) => {
                const val = editStatusValues[id];
                if (val === undefined) return;

                // AUTH CHECK & RETRY
                try {
                    if (!auth.currentUser) await signInAnonymously(auth);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id), { validationStatus: val });
                    setEditStatusValues(prev => { const next = {...prev}; delete next[id]; return next; });
                    alert("Status Validasi berhasil disimpan!");
                } catch (err) { 
                    if(err.code === 'permission-denied') {
                        try { await signInAnonymously(auth); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id), { validationStatus: val }); alert("Berhasil disimpan!"); return; } catch(e){}
                    }
                    console.error("Error saving status:", err); alert("Gagal menyimpan: " + err.message); 
                }
            };

            const downloadExcel = () => {
                if(filteredData.length === 0) return alert("Tidak ada data untuk didownload");
                const dataForExcel = filteredData.map(row => {
                    // Helper untuk Barang dan Qty
                    const itemsList = row.items || [];
                    const barangStr = itemsList.length > 0 ? itemsList.map(i => i.nama).join(', ') : (row.itemName || '-');
                    const qtyStr = itemsList.length > 0 ? itemsList.map(i => `${i.qty_kirim} ${i.uom}`).join(', ') : `${row.qty || '-'} ${row.uom || ''}`;
                    const nopolStr = row.no_truk || row.nopol || '-';
                    const customerStr = row.customerName || (row.tujuan ? row.tujuan.split('\n')[0] : '-');

                    return {
                        "Tanggal": row.tanggal,
                        "No Polisi": nopolStr,
                        "Driver": row.driver,
                        "No HP": row.noHp || '-',
                        "Customer": customerStr,
                        "Alamat Customer": row.tujuan || '',
                        "Barang": barangStr,
                        "Qty Kirim": qtyStr,
                        "Qty Actual": row.qtyActual ? Number(row.qtyActual) : '-',
                        "Ongkos Angkut": row.priceOA ? new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(row.priceOA) : '-',
                        "Validasi": row.validationStatus || 'Pending',
                        "Status Jalan": row.status === 'COMPLETED' ? 'Selesai' : 'Dalam Perjalanan',
                        "Keterangan": row.notes || ''
                    };
                });
                const ws = window.XLSX.utils.json_to_sheet(dataForExcel);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Rekap Transaksi");
                window.XLSX.writeFile(wb, `Rekap_Transaksi_${filter.startDate}_sd_${filter.endDate}.xlsx`);
            };

            return React.createElement("div", { className: "space-y-6 no-print" },
                React.createElement("div", { className: "bg-white p-6 rounded-xl border border-slate-100 shadow-sm" },
                    React.createElement("h2", { className: "font-bold text-lg mb-6 flex gap-2 items-center text-slate-800" }, 
                        React.createElement(FileSpreadsheet, { className: "text-emerald-500" }), " Rekapitulasi Data & Validasi"
                    ),
                    React.createElement("div", { className: "flex flex-col md:flex-row gap-4 items-end mb-6" },
                        React.createElement("div", { className: "w-full" }, React.createElement("label", { className: "label-text" }, "DARI TANGGAL"), React.createElement("input", { type: "date", className: "input-field", value: filter.startDate, onChange: e => setFilter({...filter, startDate: e.target.value}) })),
                        React.createElement("div", { className: "w-full" }, React.createElement("label", { className: "label-text" }, "SAMPAI TANGGAL"), React.createElement("input", { type: "date", className: "input-field", value: filter.endDate, onChange: e => setFilter({...filter, endDate: e.target.value}) })),
                        React.createElement("button", { onClick: downloadExcel, className: "w-full md:w-auto bg-emerald-600 text-white font-bold py-2.5 px-6 rounded-lg hover:bg-emerald-700 shadow-sm shadow-emerald-200 active:scale-95 transition-all flex items-center justify-center gap-2" }, 
                            React.createElement(Download, {size: 18}), "Download Excel"
                        )
                    ),
                    React.createElement("div", { className: "overflow-x-auto border border-slate-200 rounded-lg" },
                        React.createElement("table", { className: "w-full text-xs text-left whitespace-nowrap" },
                            React.createElement("thead", { className: "bg-slate-50 text-slate-600 uppercase font-bold" },
                                React.createElement("tr", null, React.createElement("th", { className: "p-4 border-b border-slate-200" }, "Tanggal"), React.createElement("th", { className: "p-4 border-b border-slate-200" }, "Nopol"), React.createElement("th", { className: "p-4 border-b border-slate-200" }, "Driver"), React.createElement("th", { className: "p-4 border-b border-slate-200" }, "Customer"), React.createElement("th", { className: "p-4 border-b border-slate-200" }, "Barang"), React.createElement("th", { className: "p-4 border-b border-slate-200 text-right" }, "Qty Kirim"), React.createElement("th", { className: "p-4 border-b border-slate-200 text-center bg-amber-50/50" }, "Qty Actual"), React.createElement("th", { className: "p-4 border-b border-slate-200 text-right" }, "Ongkos Angkut"), React.createElement("th", { className: "p-4 border-b border-slate-200 text-center bg-sky-50/50" }, "Validasi"), React.createElement("th", { className: "p-4 border-b border-slate-200" }, "Status"), React.createElement("th", { className: "p-4 border-b border-slate-200" }, "Ket"))
                            ),
                            React.createElement("tbody", null, filteredData.length === 0 ? React.createElement("tr", null, React.createElement("td", { colSpan: 11, className: "p-8 text-center text-slate-400 font-medium" }, "Tidak ada data pada periode ini.")) : filteredData.map(row => {
                                // LOGIC PERBAIKAN TAMPILAN DATA
                                const nopol = row.no_truk || row.nopol || '-';
                                const customer = row.customerName || (row.tujuan ? row.tujuan.split('\n')[0] : '-');
                                const itemsList = row.items || [];
                                const barang = itemsList.length > 0 ? itemsList.map(i => i.nama).join(', ') : (row.itemName || '-');
                                const qty = itemsList.length > 0 ? itemsList.map(i => `${i.qty_kirim} ${i.uom}`).join(', ') : `${row.qty || '-'} ${row.uom || ''}`;

                                return React.createElement("tr", { key: row.id, className: "hover:bg-slate-50/80 border-b border-slate-100" },
                                    React.createElement("td", { className: "p-4" }, row.tanggal),
                                    React.createElement("td", { className: "p-4 font-bold text-slate-700" }, nopol), // Updated
                                    React.createElement("td", { className: "p-4" }, row.driver),
                                    React.createElement("td", { className: "p-4" }, customer), // Updated
                                    React.createElement("td", { className: "p-4" }, barang), // Updated
                                    React.createElement("td", { className: "p-4 text-right font-bold" }, qty), // Updated
                                    React.createElement("td", { className: "p-3 bg-amber-50/30 text-center" }, 
                                        React.createElement("div", { className: "flex items-center justify-center gap-1" },
                                            React.createElement("input", { type: "number", className: "w-16 p-1.5 border border-amber-200 rounded text-right text-xs bg-white focus:ring-1 focus:ring-amber-400 outline-none", placeholder: row.qtyActual || "0", value: editValues[row.id] !== undefined ? editValues[row.id] : (row.qtyActual || ''), onChange: (e) => setEditValues({...editValues, [row.id]: e.target.value}) }), 
                                            editValues[row.id] !== undefined && React.createElement("button", { onClick: () => handleSaveActual(row.id), className: "p-1.5 bg-amber-500 text-white rounded hover:bg-amber-600" }, React.createElement(Save, {size:12}))
                                        )
                                    ),
                                    React.createElement("td", { className: "p-4 text-right font-mono text-slate-600" }, row.priceOA ? new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(row.priceOA) : '-'),
                                    React.createElement("td", { className: "p-3 bg-sky-50/30 text-center" }, 
                                        React.createElement("div", { className: "flex items-center justify-center gap-1" },
                                            React.createElement("select", { className: `p-1.5 border rounded text-xs outline-none cursor-pointer ${ (editStatusValues[row.id] || row.validationStatus) === 'Reject' ? 'text-red-600 font-bold border-red-200 bg-red-50' : (editStatusValues[row.id] || row.validationStatus) === 'Acc' ? 'text-emerald-600 font-bold border-emerald-200 bg-emerald-50' : 'text-slate-500 border-slate-200' }`, value: editStatusValues[row.id] !== undefined ? editStatusValues[row.id] : (row.validationStatus || ''), onChange: (e) => setEditStatusValues({...editStatusValues, [row.id]: e.target.value}) }, React.createElement("option", { value: "" }, "-"), React.createElement("option", { value: "Acc" }, "Acc"), React.createElement("option", { value: "Reject" }, "Reject")), 
                                            editStatusValues[row.id] !== undefined && React.createElement("button", { onClick: () => handleSaveStatus(row.id), className: "p-1.5 bg-sky-500 text-white rounded hover:bg-sky-600" }, React.createElement(Save, {size:12}))
                                        )
                                    ),
                                    React.createElement("td", { className: "p-4" }, 
                                        React.createElement("span", { className: `px-2 py-1 rounded-full text-[10px] font-bold ${row.status === 'COMPLETED' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}` }, 
                                            row.status === 'COMPLETED' ? 'Selesai' : 'Jalan'
                                        )
                                    ),
                                    React.createElement("td", { className: "p-4 italic text-slate-400" }, row.notes || '-')
                                )
                            }))
                        )
                    )
                )
            );
        };

        // 4. TRANSACTION FORM
        const TransactionForm = ({ user, trucks, userData }) => { // Tambahkan userData di props
            const [masterTransporters, setMasterTransporters] = useState([]);
            const [masterTrucks, setMasterTrucks] = useState([]);
            const [masterCustomers, setMasterCustomers] = useState([]);
            const [masterItems, setMasterItems] = useState([]);
            const [nextSjNumber, setNextSjNumber] = useState('0001');

            const [formData, setFormData] = useState({
                tujuan: '',
                no_sj: '',
                tanggal: new Date().toISOString().split('T')[0],
                no_so: '',
                transporter: '',
                priceOA: 0,
                driver: '',
                tipe_truk: '',
                no_truk: '',
                noHp: '', // Added noHp for WA Notification
                pallet: '',
                selectedTruckId: '',
                selectedCustomerId: '',
                customerName: '' // Tambahkan field ini
            });

            // UPDATE: Menambahkan field itemId dan code pada state items
            const [items, setItems] = useState([
                { itemId: '', code: '', nama: '', uom: '', qty_pesan: '', qty_kirim: '', berat: '', total_berat: '' }
            ]);

            const [showSettings, setShowSettings] = useState(false);
            const [showPreview, setShowPreview] = useState(false);
            const [previewUrl, setPreviewUrl] = useState('');
            const [statusMsg, setStatusMsg] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const [layoutConfig, setLayoutConfig] = useState({
                pageSize: { w: 229, h: 162 }, 
                fontSize: 10,
                fontName: 'courier', 
                globalOffset: { x: 5, y: 13 },
                headerGap: 0,
                header: {
                    no_sj: { x: 160, y: 22 }, 
                    tanggal: { x: 160, y: 26 },
                    no_so: { x: 160, y: 32.7 },
                    transporter: { x: 160, y: 36.7 },
                    tipe_truk: { x: 160, y: 44 },
                    no_truk: { x: 160, y: 48 },
                    driver: { x: 160, y: 52 }
                },
                tujuan: { x: 20, y: 32, maxWidth: 80, lineHeight: 5 },
                table: {
                    startY: 68,       
                    rowHeight: 6,     
                    cols: {           
                        kode: 12, nama: 42, uom: 95, qty_pesan: 110, qty_kirim: 130, berat: 150, total: 175
                    }
                },
                footer: {
                    pallet: { x: 90, y: 130 }
                }
            });

            useEffect(() => {
                if (!user) return;
                const x = localStorage.getItem('sj_config_offset_x');
                const y = localStorage.getItem('sj_config_offset_y');
                const hGap = localStorage.getItem('sj_config_header_gap');
                const fSize = localStorage.getItem('sj_config_font_size');

                setLayoutConfig(prev => ({
                    ...prev,
                    globalOffset: {
                        x: x !== null ? parseFloat(x) : prev.globalOffset.x,
                        y: y !== null ? parseFloat(y) : prev.globalOffset.y
                    },
                    headerGap: hGap !== null ? parseFloat(hGap) : prev.headerGap,
                    fontSize: fSize !== null ? parseFloat(fSize) : prev.fontSize
                }));

                const unsubTrans = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transporters'), s => 
                    setMasterTransporters(s.docs.map(d => ({id: d.id, ...d.data()})))
                );
                const unsubTrucks = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'trucks'), s => 
                    setMasterTrucks(s.docs.map(d => ({id: d.id, ...d.data()})))
                );
                const unsubCust = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'customers'), s => 
                    setMasterCustomers(s.docs.map(d => ({id: d.id, ...d.data()})))
                );
                const unsubItems = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'items'), s => 
                    setMasterItems(s.docs.map(d => ({id: d.id, ...d.data()})))
                );
                const unsubTransacts = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), s => {
                    const count = s.size + 1;
                    setNextSjNumber(String(count).padStart(4, '0'));
                });

                return () => {
                    unsubTrans(); unsubTrucks(); unsubCust(); unsubItems(); unsubTransacts();
                };
            }, [user]);

            useEffect(() => {
                if(nextSjNumber) {
                    const d = new Date();
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const yy = String(d.getFullYear()).slice(-2);
                    setFormData(prev => ({
                        ...prev,
                        no_sj: `SDO-MKI/${mm}/${yy}/${nextSjNumber}`
                    }));
                }
            }, [nextSjNumber]);

            const handleHeaderChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const handleTransporterSelect = (e) => {
                const selectedName = e.target.value;
                const selectedT = masterTransporters.find(t => t.name === selectedName);
                setFormData(prev => ({
                    ...prev,
                    transporter: selectedName,
                    priceOA: selectedT ? (selectedT.priceOA || 0) : 0
                }));
            };

            const handleTruckSelect = (e) => {
                const truckId = e.target.value;
                const truck = masterTrucks.find(t => t.id === truckId);
                
                if (truck) {
                    setFormData(prev => ({
                        ...prev,
                        selectedTruckId: truckId,
                        driver: truck.driver || '',
                        tipe_truk: truck.type || '',
                        no_truk: truck.nopol || '',
                        noHp: truck.noHp || '', // Capture Driver Phone for WA
                        tujuan: prev.tujuan.split('\nNo Tiket:')[0] + (truck.ticketNumber ? `\nNo Tiket: ${truck.ticketNumber}` : '')
                    }));
                    const netWeight = parseFloat(truck.netWeight) || 0;
                    const ton = netWeight / 1000;
                    setItems(prevItems => prevItems.map(item => ({
                        ...item,
                        qty_kirim: netWeight,
                        total_berat: ton
                    })));
                } else {
                    setFormData(prev => ({ ...prev, selectedTruckId: '', driver: '', tipe_truk: '', no_truk: '', noHp: '' }));
                }
            };

            const handleCustomerSelect = (e) => {
                const custId = e.target.value;
                const cust = masterCustomers.find(c => c.id === custId);
                const currentTruck = masterTrucks.find(t => t.id === formData.selectedTruckId);
                if (cust) {
                    const ticketInfo = currentTruck?.ticketNumber ? `\nNo Tiket: ${currentTruck.ticketNumber}` : '';
                    setFormData(prev => ({
                        ...prev,
                        selectedCustomerId: custId,
                        customerName: cust.name, // Simpan Nama Customer secara eksplisit
                        tujuan: `${cust.name}\n${cust.address}${ticketInfo}`
                    }));
                }
            };

            // UPDATE: Handle item select by Code
            const handleItemSelect = (index, e) => {
                const itemId = e.target.value; // This is the ID from value attribute
                const itemData = masterItems.find(i => i.id === itemId);
                const newItems = [...items];
                
                if (itemData) {
                    newItems[index].itemId = itemId;
                    newItems[index].code = itemData.code || ''; // Store the actual code string
                    newItems[index].nama = itemData.name;       // Auto-fill Name
                    newItems[index].uom = itemData.uom;         // Auto-fill UoM
                    
                    const currentTruck = masterTrucks.find(t => t.id === formData.selectedTruckId);
                    const netWeight = currentTruck ? (parseFloat(currentTruck.netWeight) || 0) : 0;
                    newItems[index].qty_kirim = netWeight;
                    newItems[index].total_berat = netWeight / 1000;
                    
                    if(itemData.notes) setFormData(prev => ({ ...prev, no_so: itemData.notes }));
                } else {
                    // Reset fields if unselected
                    newItems[index].itemId = '';
                    newItems[index].code = '';
                    newItems[index].nama = '';
                    newItems[index].uom = '';
                }
                setItems(newItems);
            };

            const handleItemChange = (index, field, value) => {
                const newItems = [...items];
                newItems[index][field] = value;
                if (field === 'qty_kirim') {
                    const qty = parseFloat(value) || 0;
                    newItems[index].total_berat = qty / 1000;
                }
                setItems(newItems);
            };

            // UPDATE: Initial state for new row
            const addItem = () => setItems([...items, { itemId: '', code: '', nama: '', uom: '', qty_pesan: '', qty_kirim: '', berat: '', total_berat: '' }]);
            const removeItem = (index) => { if (items.length > 1) setItems(items.filter((_, i) => i !== index)); };

            const createPDFObject = (data) => {
                const { jsPDF } = window.jspdf;
                const cfg = layoutConfig;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [cfg.pageSize.w, cfg.pageSize.h] });
                doc.setFont(cfg.fontName, 'normal');
                doc.setFontSize(cfg.fontSize);
                const getX = (val) => val + cfg.globalOffset.x;
                const getY = (val) => val + cfg.globalOffset.y;
                const hGap = cfg.headerGap || 0;
                const txt = (str, x, y, lineIndex = 0) => { if(str) doc.text(String(str).toUpperCase(), getX(x), getY(y) + (lineIndex * hGap)); };
                
                const h = data.header;
                const hc = cfg.header;
                txt(h.no_sj, hc.no_sj.x, hc.no_sj.y, 0);
                let tgl = h.tanggal;
                if (tgl) { const d = new Date(tgl); tgl = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`; }
                txt(tgl, hc.tanggal.x, hc.tanggal.y, 1);
                txt(h.no_so, hc.no_so.x, hc.no_so.y, 2);
                txt(h.transporter, hc.transporter.x, hc.transporter.y, 3);
                txt(h.tipe_truk, hc.tipe_truk.x, hc.tipe_truk.y, 4);
                txt(h.no_truk, hc.no_truk.x, hc.no_truk.y, 5);
                txt(h.driver, hc.driver.x, hc.driver.y, 6);
                
                const tc = cfg.tujuan;
                if (h.tujuan) {
                    const splitTujuan = doc.splitTextToSize(h.tujuan.toUpperCase(), tc.maxWidth);
                    doc.text(splitTujuan, getX(tc.x), getY(tc.y));
                }

                let currentY = cfg.table.startY;
                const tableC = cfg.table;
                data.items.forEach(item => {
                    const txtTable = (str, x, y) => { if(str) doc.text(String(str).toUpperCase(), getX(x), getY(y)); };
                    // UPDATE: Print the actual CODE string, not ID
                    txtTable(item.code, tableC.cols.kode, currentY);
                    txtTable(item.nama, tableC.cols.nama, currentY);
                    txtTable(item.uom, tableC.cols.uom, currentY);
                    txtTable(item.qty_pesan, tableC.cols.qty_pesan, currentY);
                    txtTable(item.qty_kirim, tableC.cols.qty_kirim, currentY);
                    txtTable(item.berat, tableC.cols.berat, currentY);
                    txtTable(item.total_berat, tableC.cols.total, currentY);
                    currentY += tableC.rowHeight;
                });
                if (h.pallet) {
                    const txtFooter = (str, x, y) => { if(str) doc.text(String(str).toUpperCase(), getX(x), getY(y)); };
                    txtFooter(h.pallet, cfg.footer.pallet.x, cfg.footer.pallet.y);
                }
                return doc;
            };

            const handlePreview = () => {
                if(!formData.no_sj) { alert('Mohon isi No. Surat Jalan (minimal dummy) untuk preview'); return; }
                const doc = createPDFObject({ header: formData, items: items.filter(i => i.nama) });
                setPreviewUrl(doc.output('datauristring'));
                setShowPreview(true);
            };

            const handleSave = async (e) => {
                e.preventDefault();
                setIsSaving(true);

                // AUTH CHECK
                if (!auth.currentUser) { 
                    try { await signInAnonymously(auth); } 
                    catch(e) { 
                        setIsSaving(false); 
                        return alert("Koneksi terputus. Mohon refresh halaman."); 
                    } 
                }

                try {
                    // 1. Simpan Transaksi dengan status 'ACTIVE'
                    const dataToSave = { 
                        ...formData, 
                        items: items.filter(i => i.nama), 
                        timestamp: serverTimestamp(), 
                        createdBy: user.uid, 
                        status: 'ACTIVE' // STATUS ACTIVE
                    };
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), dataToSave);
                    
                    // 2. Update status Armada jadi 'BUSY'
                    if (formData.selectedTruckId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trucks', formData.selectedTruckId), {
                            status: 'BUSY'
                        });
                    }

                    // 3. KIRIM NOTIFIKASI WA (Dipindahkan ke sini)
                    let waStatus = "";
                    try {
                        const settingsSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'));
                        if (settingsSnap.exists()) {
                            const settings = settingsSnap.data();
                            const wa = settings.waConfig;
                            
                            if (wa && wa.token && wa.targetGroups) {
                                const token = wa.token.trim();
                                const target = wa.targetGroups.trim();

                                // Construct Message
                                const itemsList = items.filter(i => i.nama);
                                let rincianProduk = "";
                                itemsList.forEach((item, index) => {
                                    rincianProduk += `${index + 1}. ${item.nama}\n   📦 ${item.qty_kirim} ${item.uom}\n   📝 Ket: ${item.notes || '-'}\n`;
                                });

                                // Gunakan userData untuk nama user, fallback ke 'Admin'
                                const userName = userData ? userData.username : 'Admin';

                                const message = `*LAPORAN TRANSAKSI KIRIMAN*\n` +
                                    `📅 Tgl : ${new Date().toLocaleString('id-ID')} WIB\n` +
                                    `🔄 Tipe : Cetak SPJ\n` +
                                    `👤 User : ${userName}\n\n` +
                                    `📄 No. POL : ${formData.no_truk || '-'}\n` +
                                    `      Driver : ${formData.driver || '-'}\n` +
                                    `      Tlp : ${formData.noHp || '-'}\n` +
                                    `📍 Tujuan : ${formData.customerName || (formData.tujuan ? formData.tujuan.split('\n')[0] : '-')}\n\n` +
                                    `Rincian Produk\n` +
                                    `--------------------------------\n` +
                                    `${rincianProduk}`;

                                const waFormData = new FormData();
                                waFormData.append('target', target);
                                waFormData.append('message', message);
                                waFormData.append('delay', '2'); 

                                // Kirim tanpa await blocking (background process) agar PDF cepat keluar
                                fetch("https://api.fonnte.com/send", {
                                    method: 'POST',
                                    headers: { 'Authorization': token },
                                    body: waFormData
                                })
                                .then(res => res.json())
                                .then(res => console.log("WA Sent:", res))
                                .catch(err => console.error("WA Error:", err));
                                
                                waStatus = " & WA Terkirim";
                            }
                        }
                    } catch (waErr) {
                        console.error("WA Config Error:", waErr);
                    }

                    // 4. Download PDF
                    const docPDF = createPDFObject({ header: formData, items: items.filter(i => i.nama) });
                    docPDF.save(`SJ_${formData.no_sj || 'Draft'}.pdf`);
                    
                    setStatusMsg(`Data Disimpan${waStatus}, Armada BUSY & PDF Didownload!`);
                    setFormData(prev => ({ ...prev, tujuan: '', selectedCustomerId: '', customerName: '', no_so: '', priceOA: 0, selectedTruckId: '', driver: '', no_truk: '', noHp: '', tipe_truk: '' }));
                    setItems([{ itemId: '', code: '', nama: '', uom: '', qty_pesan: '', qty_kirim: '', berat: '', total_berat: '' }]);
                } catch (error) {
                    console.error("Error saving:", error);
                    if (error.code === 'permission-denied') {
                        alert("⛔ GAGAL MENYIMPAN: IZIN DITOLAK FIREBASE");
                    } else {
                        setStatusMsg('Gagal menyimpan data: ' + error.message);
                    }
                }
                setIsSaving(false);
            };

            // Settings Modal (inline)
            const SettingsModal = () => {
                const [localCfg, setLocalCfg] = useState(layoutConfig);
                const updateVal = (key, val) => setLocalCfg(prev => {
                    const next = { ...prev };
                    if (key === 'offsetX') next.globalOffset.x = parseFloat(val);
                    if (key === 'offsetY') next.globalOffset.y = parseFloat(val);
                    if (key === 'headerGap') next.headerGap = parseFloat(val);
                    if (key === 'fontSize') next.fontSize = parseFloat(val);
                    return next;
                });
                const adjust = (key, delta) => {
                    let current = 0;
                    if (key === 'offsetX') current = localCfg.globalOffset.x;
                    if (key === 'offsetY') current = localCfg.globalOffset.y;
                    if (key === 'headerGap') current = localCfg.headerGap;
                    updateVal(key, (current + delta).toFixed(1));
                };

                return React.createElement("div", { className: "fixed inset-0 z-50 flex items-center justify-center p-4 preview-modal" },
                    React.createElement("div", { className: "bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden" },
                        React.createElement("div", { className: "flex justify-between items-center p-4 border-b" }, React.createElement("h3", { className: "text-lg font-medium" }, "Pengaturan Kertas"), React.createElement("button", { onClick: () => setShowSettings(false), className: "text-gray-400 hover:text-gray-500" }, React.createElement(X, { size: 20 }))),
                        React.createElement("div", { className: "p-4 space-y-4 bg-gray-50" },
                            React.createElement("div", null, React.createElement("label", { className: "block text-sm font-bold text-gray-700" }, "Geser Horizontal (X) - mm"), React.createElement("div", { className: "flex items-center mt-1" }, React.createElement("button", { onClick: () => adjust('offsetX', -1), className: "p-2 bg-gray-200 rounded-l hover:bg-gray-300" }, "-"), React.createElement("input", { type: "number", className: "block w-full text-center border-gray-300 h-9 border-t border-b", value: localCfg.globalOffset.x, onChange: e => updateVal('offsetX', e.target.value) }), React.createElement("button", { onClick: () => adjust('offsetX', 1), className: "p-2 bg-gray-200 rounded-r hover:bg-gray-300" }, "+"))),
                            React.createElement("div", null, React.createElement("label", { className: "block text-sm font-bold text-gray-700" }, "Geser Vertikal (Y) - mm"), React.createElement("div", { className: "flex items-center mt-1" }, React.createElement("button", { onClick: () => adjust('offsetY', -1), className: "p-2 bg-gray-200 rounded-l hover:bg-gray-300" }, "-"), React.createElement("input", { type: "number", className: "block w-full text-center border-gray-300 h-9 border-t border-b", value: localCfg.globalOffset.y, onChange: e => updateVal('offsetY', e.target.value) }), React.createElement("button", { onClick: () => adjust('offsetY', 1), className: "p-2 bg-gray-200 rounded-r hover:bg-gray-300" }, "+"))),
                            React.createElement("div", null, React.createElement("label", { className: "block text-sm font-bold text-gray-700" }, "Jarak Antar Baris Header - mm"), React.createElement("div", { className: "flex items-center mt-1" }, React.createElement("button", { onClick: () => adjust('headerGap', -0.5), className: "p-2 bg-gray-200 rounded-l hover:bg-gray-300" }, "-"), React.createElement("input", { type: "number", className: "block w-full text-center border-gray-300 h-9 border-t border-b", value: localCfg.headerGap, onChange: e => updateVal('headerGap', e.target.value) }), React.createElement("button", { onClick: () => adjust('headerGap', 0.5), className: "p-2 bg-gray-200 rounded-r hover:bg-gray-300" }, "+"))),
                            React.createElement("div", null, React.createElement("label", { className: "block text-sm font-bold text-gray-700" }, "Ukuran Font (pt)"), React.createElement("input", { type: "number", className: "input-field mt-1", value: localCfg.fontSize, onChange: e => updateVal('fontSize', e.target.value) }))
                        ),
                        React.createElement("div", { className: "p-4 flex flex-col gap-2" },
                            React.createElement("button", { onClick: () => { saveSettings(localCfg); setShowSettings(false); setTimeout(handlePreview, 300); }, className: "w-full px-4 py-2 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700 flex justify-center items-center gap-2" }, React.createElement("i", { className: "fa-solid fa-check-double" }), "Simpan & Lihat Preview"),
                            React.createElement("button", { onClick: () => { saveSettings(localCfg); setShowSettings(false); }, className: "w-full px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded hover:bg-gray-50 font-medium" }, "Simpan Saja")
                        )
                    )
                );
            };

            return React.createElement("div", { className: "max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden relative no-print" },
                React.createElement("div", { className: "bg-indigo-600 px-6 py-4 flex justify-between items-center" },
                    React.createElement("div", null, React.createElement("h2", { className: "text-xl font-bold text-white" }, "Input Surat Jalan MKI"), React.createElement("p", { className: "text-indigo-100 text-sm" }, "Setting Printer: Envelope C5 (229x162mm)")),
                    React.createElement("div", { className: "flex items-center gap-5" },
                        React.createElement("button", { onClick: handlePreview, className: "text-indigo-200 hover:text-white transition flex flex-col items-center group", title: "Preview PDF" }, React.createElement("i", { className: "fa-solid fa-eye text-xl mb-1 group-hover:scale-110 transition-transform" }), React.createElement("span", { className: "text-[10px] font-medium uppercase tracking-wider" }, "Preview")),
                        React.createElement("div", { className: "h-8 w-px bg-indigo-500" }),
                        React.createElement("button", { onClick: () => setShowSettings(true), className: "text-indigo-200 hover:text-white transition flex flex-col items-center group", title: "Pengaturan Kertas" }, React.createElement("i", { className: "fa-solid fa-gear text-xl mb-1 group-hover:rotate-45 transition-transform duration-300" }), React.createElement("span", { className: "text-[10px] font-medium uppercase tracking-wider" }, "Setting"))
                    )
                ),
                React.createElement("form", { onSubmit: handleSave, className: "p-6 space-y-6" },
                    React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-6" },
                        React.createElement("div", { className: "space-y-4" },
                            React.createElement("div", null,
                                React.createElement("label", { className: "label-text" }, "Customer / Tujuan"),
                                React.createElement("select", { className: "input-field mb-2", value: formData.selectedCustomerId, onChange: handleCustomerSelect },
                                    React.createElement("option", { value: "" }, "- Pilih Customer -"),
                                    masterCustomers.map(c => React.createElement("option", { key: c.id, value: c.id }, c.name))
                                ),
                                React.createElement("textarea", { name: "tujuan", required: true, className: "input-field h-24", placeholder: "Detail Alamat...", value: formData.tujuan, onChange: handleHeaderChange })
                            )
                        ),
                        React.createElement("div", { className: "space-y-3 bg-gray-50 p-4 rounded-md border" },
                            React.createElement("div", { className: "grid grid-cols-2 gap-2" },
                                React.createElement("div", null, React.createElement("label", { className: "label-text" }, "No. Surat Jalan"), React.createElement("input", { type: "text", name: "no_sj", required: true, className: "input-field bg-gray-100", value: formData.no_sj, readOnly: true })),
                                React.createElement("div", null, React.createElement("label", { className: "label-text" }, "Tanggal"), React.createElement("input", { type: "date", name: "tanggal", required: true, className: "input-field", value: formData.tanggal, onChange: handleHeaderChange }))
                            ),
                            React.createElement("div", null, React.createElement("label", { className: "label-text" }, "No. SO"), React.createElement("input", { type: "text", name: "no_so", className: "input-field bg-gray-50", value: formData.no_so, onChange: handleHeaderChange, placeholder: "Auto from Item" })),
                            React.createElement("div", { className: "grid grid-cols-2 gap-2" },
                                React.createElement("div", null, React.createElement("label", { className: "label-text" }, "Transporter"), React.createElement("select", { name: "transporter", className: "input-field", value: formData.transporter, onChange: handleTransporterSelect }, React.createElement("option", { value: "" }, "- Pilih -"), masterTransporters.map(t => React.createElement("option", { key: t.id, value: t.name }, t.name)))),
                                React.createElement("div", null, React.createElement("label", { className: "label-text" }, "Armada"), React.createElement("select", { className: "input-field", value: formData.selectedTruckId, onChange: handleTruckSelect }, React.createElement("option", { value: "" }, "- Pilih Nopol -"), 
                                    // LOGIC BARU: Filter Armada yang tidak sedang BUSY
                                    masterTrucks.filter(t => t.status !== 'BUSY').map(t => React.createElement("option", { key: t.id, value: t.id }, t.nopol))
                                ))
                            ),
                            React.createElement("div", { className: "grid grid-cols-3 gap-2" },
                                React.createElement("div", null, React.createElement("label", { className: "label-text text-xs" }, "Driver"), React.createElement("input", { type: "text", name: "driver", className: "input-field bg-gray-100", value: formData.driver, readOnly: true })),
                                React.createElement("div", null, React.createElement("label", { className: "label-text text-xs" }, "Tipe"), React.createElement("input", { type: "text", name: "tipe_truk", className: "input-field bg-gray-100", value: formData.tipe_truk, readOnly: true })),
                                React.createElement("div", null, React.createElement("label", { className: "label-text text-xs" }, "Nopol"), React.createElement("input", { type: "text", name: "no_truk", className: "input-field bg-gray-100", value: formData.no_truk, readOnly: true }))
                            )
                        )
                    ),
                    React.createElement("div", null,
                        React.createElement("h3", { className: "text-lg font-medium text-gray-900 border-b pb-2 mb-3" }, "Daftar Barang"),
                        React.createElement("div", { className: "overflow-x-auto" },
                            React.createElement("table", { className: "min-w-full divide-y divide-gray-200" },
                                React.createElement("thead", { className: "bg-gray-50" }, 
                                    React.createElement("tr", null, 
                                        React.createElement("th", { className: "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24" }, "Kode"),
                                        React.createElement("th", { className: "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-1/3" }, "Nama Item"),
                                        React.createElement("th", { className: "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase" }, "UoM"),
                                        React.createElement("th", { className: "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase" }, "Qty Pesan"),
                                        React.createElement("th", { className: "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase" }, "Qty Kirim"),
                                        React.createElement("th", { className: "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase" }, "Berat"),
                                        React.createElement("th", { className: "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase" }, "Total"),
                                        React.createElement("th", { className: "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase" }, "")
                                    )
                                ),
                                React.createElement("tbody", { className: "bg-white divide-y divide-gray-200" }, items.map((item, idx) => 
                                    React.createElement("tr", { key: idx },
                                        React.createElement("td", { className: "px-2 py-1" }, 
                                            React.createElement("select", { className: "input-field text-xs", value: item.itemId, onChange: (e) => handleItemSelect(idx, e) }, 
                                                React.createElement("option", { value: "" }, "-"), 
                                                masterItems.map(i => React.createElement("option", { key: i.id, value: i.id }, i.code || i.name))
                                            )
                                        ),
                                        React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "text", className: "input-field text-xs bg-gray-50", value: item.nama, readOnly: true })),
                                        React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "text", className: "input-field text-xs bg-gray-50", value: item.uom, readOnly: true })),
                                        
                                        React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "number", className: "input-field text-xs", value: item.qty_pesan, onChange: e => handleItemChange(idx, 'qty_pesan', e.target.value) })),
                                        React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "number", className: "input-field text-xs bg-yellow-50", value: item.qty_kirim, onChange: e => handleItemChange(idx, 'qty_kirim', e.target.value) })),
                                        React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "number", className: "input-field text-xs", step: "0.01", value: item.berat, onChange: e => handleItemChange(idx, 'berat', e.target.value) })),
                                        React.createElement("td", { className: "px-2 py-1" }, React.createElement("input", { type: "number", className: "input-field text-xs bg-gray-50", step: "0.001", value: item.total_berat, readOnly: true })),
                                        React.createElement("td", { className: "px-2 py-1 text-center" }, React.createElement("button", { type: "button", onClick: () => removeItem(idx), className: "text-red-600 hover:text-red-900 font-bold" }, "X"))
                                    )
                                ))
                            )
                        ),
                        React.createElement("button", { type: "button", onClick: addItem, className: "mt-3 inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200" }, "+ Tambah Baris")
                    ),
                    React.createElement("div", { className: "grid grid-cols-2 gap-4" }, React.createElement("div", null, React.createElement("label", { className: "label-text" }, "Jumlah Pallet"), React.createElement("input", { type: "text", name: "pallet", className: "input-field w-32", value: formData.pallet, onChange: handleHeaderChange }))),
                    React.createElement("div", { className: "flex justify-end gap-3 pt-4 border-t items-center" },
                        React.createElement("button", { type: "button", onClick: handlePreview, className: "inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" }, "Cek Preview"),
                        React.createElement("button", { type: "submit", disabled: isSaving, className: "inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50" }, isSaving ? "Menyimpan..." : "Simpan & PDF")
                    ),
                    statusMsg && React.createElement("div", { className: `p-4 rounded-md ${statusMsg.includes('Gagal') ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}` }, statusMsg)
                ),
                showPreview && React.createElement("div", { className: "fixed inset-0 z-50 flex items-center justify-center p-4 preview-modal" },
                    React.createElement("div", { className: "bg-white rounded-lg shadow-xl w-full max-w-5xl h-[90vh] flex flex-col" },
                        React.createElement("div", { className: "bg-gray-100 px-4 py-3 border-b flex justify-between items-center" }, React.createElement("h3", { className: "text-lg font-medium text-gray-900" }, "Preview PDF"), React.createElement("button", { onClick: () => setShowPreview(false), className: "text-gray-500" }, "Close")),
                        React.createElement("div", { className: "flex-grow bg-gray-500 p-4" }, React.createElement("iframe", { src: previewUrl, className: "w-full h-full rounded shadow-lg border-0" }))
                    )
                ),
                showSettings && React.createElement(SettingsModal)
            );
        };

        const TransactionHistory = ({ user, userData }) => {
            const [transactions, setTransactions] = useState([]);
            
            useEffect(() => {
                if (!user) return;
                const unsub = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'transactions')), s => {
                    const data = s.docs.map(d => ({id: d.id, ...d.data()}));
                    setTransactions(data.sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0)));
                });
                return () => unsub();
            }, [user]);
            
            // LOGIC BARU: TOMBOL SELESAI (DISEDERHANAKAN KEMBALI)
            const handleFinish = async (t) => { 
                const pass = prompt("Masukkan Password Admin untuk Menyelesaikan Transaksi:");
                if(pass !== 'admin123') return alert("Password Salah!");
                
                if(!confirm("Yakin selesaikan? Armada akan dihapus dari daftar aktif.")) return;
                
                try {
                    if (!auth.currentUser) await signInAnonymously(auth);
                    
                    // 1. Update Status Transaksi -> COMPLETED
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', t.id), { status: 'COMPLETED' }); 

                    // 2. Hapus Armada dari Database
                    if(t.selectedTruckId) {
                         try {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trucks', t.selectedTruckId));
                         } catch(e) { console.log("Truck ref not found or already deleted"); }
                    }
                    alert("Transaksi Selesai. Armada dihapus dari daftar.");
                } catch(e) {
                    console.error(e);
                    alert("Gagal update status database: " + e.message);
                }
            };
            
            // LOGIC BARU: TOMBOL UNDO (Hapus Transaksi)
            const handleDelete = async (t) => { 
                const pass = prompt("Masukkan Password Admin untuk Membatalkan/Menghapus Transaksi:");
                if(pass !== 'admin123') return alert("Password Salah!");

                if(!confirm("Hapus permanen transaksi ini & kembalikan status armada jadi AVAILABLE?")) return; 
                
                try {
                    if (!auth.currentUser) await signInAnonymously(auth);
                    
                    // 1. Hapus Transaksi
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', t.id)); 
                    
                    // 2. Kembalikan Status Armada -> AVAILABLE (agar muncul lagi di menu)
                    if(t.selectedTruckId) {
                        try {
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trucks', t.selectedTruckId), {
                                status: 'AVAILABLE'
                            });
                        } catch (err) {
                            console.log("Truck mungkin sudah dihapus, skip update status.");
                        }
                    }
                    alert("Transaksi dibatalkan. Armada kembali tersedia.");
                } catch(e) {
                    console.error(e);
                    alert("Gagal menghapus.");
                }
            };
            
            return React.createElement("div", { className: "space-y-3 no-print" },
                React.createElement("h2", { className: "font-bold text-lg" }, "Log Transaksi"),
                transactions.length === 0 ? React.createElement("p", {className: "text-center text-slate-400 py-10"}, "Belum ada riwayat.") : transactions.map(t => {
                    // PERBAIKAN LOGIKA TAMPILAN DATA (Agar tidak undefined)
                    const nopolDisplay = t.no_truk || t.nopol || 'No Polisi?';
                    const customerDisplay = t.customerName || (t.tujuan ? t.tujuan.split('\n')[0] : 'Customer?');
                    
                    let itemsDisplay = '-';
                    if (t.items && Array.isArray(t.items) && t.items.length > 0) {
                        // Gabungkan semua item menjadi satu string
                        itemsDisplay = t.items.map(i => `${i.nama} (${i.qty_kirim} ${i.uom})`).join(', ');
                    } else if (t.itemName) {
                        // Fallback untuk data lama
                        itemsDisplay = `${t.itemName} (${t.qty || 0} ${t.uom || ''})`;
                    }

                    return React.createElement("div", { key: t.id, className: "bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center" },
                        React.createElement("div", null, 
                            React.createElement("p", { className: "font-black" }, nopolDisplay), 
                            React.createElement("p", { className: "text-sm" }, customerDisplay), 
                            React.createElement("p", { className: "text-xs text-blue-600" }, itemsDisplay),
                            t.status === 'ACTIVE' ? 
                                React.createElement("span", { className: "text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded font-bold" }, "DALAM PROSES") :
                                React.createElement("span", { className: "text-[10px] bg-green-100 text-green-800 px-2 py-0.5 rounded font-bold" }, "SELESAI")
                        ),
                        React.createElement("div", { className: "flex gap-2" }, 
                            t.status === 'ACTIVE' && React.createElement("button", { onClick: () => handleFinish(t), className: "bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600 transition-colors" }, "SELESAI"), 
                            React.createElement("button", { onClick: () => handleDelete(t), className: "text-red-400 hover:text-red-600 p-2" }, React.createElement(Trash2, { size: 18 }))
                        )
                    );
                })
            );
        };

        const MasterCustomerForm = ({ user }) => {
            const [formData, setFormData] = useState({ name: '', address: '', district: '' });
            const [customers, setCustomers] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [editData, setEditData] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => { if (!user) return; return onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'customers')), s => setCustomers(s.docs.map(d => ({id: d.id, ...d.data()})))); }, [user]);
            
            const handleSubmit = async (e) => { 
                e.preventDefault(); 
                setIsSubmitting(true);

                // FIX: Auto-reconnect if auth is lost
                if (!auth.currentUser) {
                    try { await signInAnonymously(auth); } catch(e) { console.error("Reconnect failed"); }
                }

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'customers'), { ...formData, createdAt: serverTimestamp() }); 
                    setFormData({ name: '', address: '', district: '' }); 
                    alert("Customer berhasil disimpan!");
                } catch (error) {
                    console.error("Error saving customer:", error);
                    if (error.code === 'permission-denied') {
                        alert("⛔ GAGAL MENYIMPAN: IZIN DITOLAK FIREBASE");
                    } else {
                        alert("Gagal menyimpan: " + error.message);
                    }
                } finally {
                    setIsSubmitting(false);
                }
            };

            const saveEdit = async () => { 
                if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'customers', editingId), { name: editData.name, address: editData.address, district: editData.district }); 
                    setEditingId(null);
                } catch (error) {
                    if (error.code === 'permission-denied') alert("Gagal Edit: Cek Rules Firebase Console Anda.");
                }
            };
            const deleteCustomer = async (id) => { 
                if(confirm("Hapus?")) {
                    if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'customers', id)); 
                    } catch (error) {
                        if (error.code === 'permission-denied') alert("Gagal Hapus: Cek Rules Firebase Console Anda.");
                    }
                }
            };
            
            return React.createElement("div", { className: "space-y-6 no-print" },
                React.createElement("div", { className: "bg-white p-4 rounded-xl border" }, React.createElement("h2", { className: "font-bold mb-4" }, "Data Customer"), React.createElement("form", { onSubmit: handleSubmit, className: "space-y-3" }, React.createElement("input", { required: true, placeholder: "Nama", className: "w-full p-2 border rounded", value: formData.name, onChange: e => setFormData({...formData, name: e.target.value}) }), React.createElement("input", { placeholder: "Distrik", className: "w-full p-2 border rounded", value: formData.district, onChange: e => setFormData({...formData, district: e.target.value}) }), React.createElement("textarea", { placeholder: "Alamat", className: "w-full p-2 border rounded", value: formData.address, onChange: e => setFormData({...formData, address: e.target.value}) }), 
                React.createElement("button", { type: "submit", disabled: isSubmitting, className: "w-full bg-slate-800 text-white p-2 rounded disabled:opacity-50" }, isSubmitting ? "Menyimpan..." : "Simpan"))),
                React.createElement("div", { className: "bg-white p-4 rounded-xl border" }, React.createElement("h3", { className: "font-bold mb-4" }, "Daftar Customer"), React.createElement("div", { className: "overflow-x-auto" }, React.createElement("table", { className: "w-full text-sm text-left" }, React.createElement("thead", { className: "bg-slate-50 font-bold" }, React.createElement("tr", null, React.createElement("th", {className:"p-3"}, "Nama"), React.createElement("th", {className:"p-3"}, "Distrik"), React.createElement("th", {className:"p-3"}, "Alamat"), React.createElement("th", {className:"p-3"}, "Aksi"))), React.createElement("tbody", null, customers.map(c => editingId === c.id ? React.createElement("tr", { key: c.id }, React.createElement("td", {className:"p-2"}, React.createElement("input", {value: editData.name, onChange: e=>setEditData({...editData, name:e.target.value})})), React.createElement("td", {className:"p-2"}, React.createElement("input", {value: editData.district, onChange: e=>setEditData({...editData, district:e.target.value})})), React.createElement("td", {className:"p-2"}, React.createElement("input", {value: editData.address, onChange: e=>setEditData({...editData, address:e.target.value})})), React.createElement("td", {className:"p-2"}, React.createElement("button", {onClick: saveEdit}, "Simpan"))) : React.createElement("tr", { key: c.id, className: "border-b" }, React.createElement("td", {className:"p-3"}, c.name), React.createElement("td", {className:"p-3"}, c.district), React.createElement("td", {className:"p-3"}, c.address), React.createElement("td", {className:"p-3"}, React.createElement("button", {onClick: ()=> {setEditingId(c.id); setEditData(c)}}, "Edit"), React.createElement("button", {onClick: ()=>deleteCustomer(c.id), className:"ml-2 text-red-500"}, "Hapus"))))))))
            );
        };

        const MasterTransporterForm = ({ user }) => {
            const [formData, setFormData] = useState({ name: '', address: '', phone: '', district: '', priceOA: '' });
            const [transporters, setTransporters] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [editData, setEditData] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => { if (!user) return; return onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'transporters')), s => setTransporters(s.docs.map(d => ({id: d.id, ...d.data()})))); }, [user]);
            
            const handleSubmit = async (e) => { 
                e.preventDefault(); 
                setIsSubmitting(true);

                // 1. Cek User Auth Firebase (Robust Reconnect)
                let currentUser = auth.currentUser;
                if (!currentUser) {
                    try {
                        const userCredential = await signInAnonymously(auth);
                        currentUser = userCredential.user;
                    } catch (authErr) {
                        console.error("Auth failed:", authErr);
                        alert("Gagal terhubung ke database (Auth Error). Mohon refresh halaman.");
                        setIsSubmitting(false);
                        return; // STOP HERE
                    }
                }

                // 2. Lanjut Simpan
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transporters'), { ...formData, priceOA: Number(formData.priceOA), createdAt: serverTimestamp() }); 
                    setFormData({ name: '', address: '', phone: '', district: '', priceOA: '' }); 
                    alert("Transporter berhasil disimpan!");
                } catch (error) {
                    console.error("Error saving transporter:", error);
                    if (error.code === 'permission-denied') {
                        alert("⛔ GAGAL MENYIMPAN: IZIN DITOLAK FIREBASE");
                    } else {
                        alert("Gagal menyimpan: " + error.message);
                    }
                } finally {
                    setIsSubmitting(false);
                }
            };

            const saveEdit = async () => { 
                if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transporters', editingId), { name: editData.name, address: editData.address, phone: editData.phone, district: editData.district, priceOA: Number(editData.priceOA) }); 
                    setEditingId(null); 
                } catch (error) {
                    if (error.code === 'permission-denied') alert("Gagal Edit: Cek Rules Firebase Console Anda.");
                }
            };
            const deleteTransporter = async (id) => { 
                if(confirm("Hapus?")) {
                    if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transporters', id)); 
                    } catch (error) {
                        if (error.code === 'permission-denied') alert("Gagal Hapus: Cek Rules Firebase Console Anda.");
                    }
                }
            };
            
            return React.createElement("div", { className: "space-y-6 no-print" },
                React.createElement("div", { className: "bg-white p-4 rounded-xl border" }, React.createElement("h2", { className: "font-bold mb-4" }, "Data Transporter"), React.createElement("form", { onSubmit: handleSubmit, className: "space-y-3" }, React.createElement("input", { required: true, placeholder: "Nama", className: "w-full p-2 border rounded", value: formData.name, onChange: e => setFormData({...formData, name: e.target.value}) }), React.createElement("div", {className:"grid grid-cols-2 gap-2"}, React.createElement("input", { placeholder: "Kontak", className: "w-full p-2 border rounded", value: formData.phone, onChange: e => setFormData({...formData, phone: e.target.value}) }), React.createElement("input", { placeholder: "Distrik", className: "w-full p-2 border rounded", value: formData.district, onChange: e => setFormData({...formData, district: e.target.value}) })), React.createElement("input", { type: "number", placeholder: "Harga OA", className: "w-full p-2 border rounded", value: formData.priceOA, onChange: e => setFormData({...formData, priceOA: e.target.value}) }), React.createElement("textarea", { placeholder: "Alamat", className: "w-full p-2 border rounded", value: formData.address, onChange: e => setFormData({...formData, address: e.target.value}) }), 
                React.createElement("button", { type: "submit", disabled: isSubmitting, className: "w-full bg-slate-800 text-white p-2 rounded disabled:opacity-50" }, isSubmitting ? "Menyimpan..." : "Simpan"))),
                React.createElement("div", { className: "bg-white p-4 rounded-xl border" }, React.createElement("h3", { className: "font-bold mb-4" }, "Daftar Transporter"), React.createElement("div", { className: "overflow-x-auto" }, React.createElement("table", { className: "w-full text-sm text-left" }, React.createElement("thead", { className: "bg-slate-50 font-bold" }, React.createElement("tr", null, React.createElement("th", {className:"p-3"}, "Nama"), React.createElement("th", {className:"p-3"}, "Distrik"), React.createElement("th", {className:"p-3"}, "OA"), React.createElement("th", {className:"p-3"}, "Kontak"), React.createElement("th", {className:"p-3"}, "Aksi"))), React.createElement("tbody", null, transporters.map(t => editingId === t.id ? React.createElement("tr", { key: t.id }, React.createElement("td", {className:"p-2"}, React.createElement("input", {value: editData.name, onChange: e=>setEditData({...editData, name:e.target.value})})), React.createElement("td", {className:"p-2"}, React.createElement("input", {value: editData.district, onChange: e=>setEditData({...editData, district:e.target.value})})), React.createElement("td", {className:"p-2"}, React.createElement("input", {value: editData.priceOA, onChange: e=>setEditData({...editData, priceOA:e.target.value})})), React.createElement("td", {className:"p-2"}, React.createElement("input", {value: editData.phone, onChange: e=>setEditData({...editData, phone:e.target.value})})), React.createElement("td", {className:"p-2"}, React.createElement("button", {onClick: saveEdit}, "Simpan"))) : React.createElement("tr", { key: t.id, className: "border-b" }, React.createElement("td", {className:"p-3"}, t.name), React.createElement("td", {className:"p-3"}, t.district), React.createElement("td", {className:"p-3"}, t.priceOA), React.createElement("td", {className:"p-3"}, t.phone), React.createElement("td", {className:"p-3"}, React.createElement("button", {onClick: ()=> {setEditingId(t.id); setEditData(t)}}, "Edit"), React.createElement("button", {onClick: ()=>deleteTransporter(t.id), className:"ml-2 text-red-500"}, "Hapus"))))))))
            );
        };

        const MasterItemForm = ({ user }) => {
            const [formData, setFormData] = useState({ code: '', name: '', uom: 'PCS', notes: '' });
            const [items, setItems] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [editData, setEditData] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => { if (!user) return; return onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'items')), s => setItems(s.docs.map(d => ({id: d.id, ...d.data()})))); }, [user]);
            
            const handleSubmit = async (e) => { 
                e.preventDefault(); 
                setIsSubmitting(true);

                // FIX: Auto-reconnect
                if (!auth.currentUser) {
                    try { await signInAnonymously(auth); } catch(e) { console.error("Reconnect failed"); }
                }

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'items'), { ...formData, createdAt: serverTimestamp() }); 
                    setFormData({ code: '', name: '', uom: 'PCS', notes: '' }); 
                    alert("Barang berhasil disimpan!");
                } catch (error) {
                    console.error("Error saving item:", error);
                    if (error.code === 'permission-denied') {
                        alert("⛔ GAGAL MENYIMPAN: IZIN DITOLAK FIREBASE");
                    } else {
                        alert("Gagal menyimpan: " + error.message);
                    }
                } finally {
                    setIsSubmitting(false);
                }
            };

            const saveEdit = async () => { 
                if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', editingId), { code: editData.code || '', name: editData.name, uom: editData.uom, notes: editData.notes || '' }); setEditingId(null); 
                } catch (error) {
                    if (error.code === 'permission-denied') alert("Gagal Edit: Cek Rules Firebase Console Anda.");
                }
            };
            const deleteItem = async (id) => { 
                if(confirm("Hapus?")) {
                    if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'items', id)); 
                    } catch (error) {
                        if (error.code === 'permission-denied') alert("Gagal Hapus: Cek Rules Firebase Console Anda.");
                    }
                }
            };
            
            return React.createElement("div", { className: "space-y-6 no-print" },
                React.createElement("div", { className: "bg-white p-4 rounded-xl border" }, React.createElement("h2", { className: "font-bold mb-4" }, "Data Barang"), React.createElement("form", { onSubmit: handleSubmit, className: "space-y-3" }, 
                    React.createElement("div", {className:"grid grid-cols-1 md:grid-cols-2 gap-2"},
                        React.createElement("input", { placeholder: "Kode Barang", className: "w-full p-2 border rounded", value: formData.code, onChange: e => setFormData({...formData, code: e.target.value}) }),
                        React.createElement("input", { required: true, placeholder: "Nama Barang", className: "w-full p-2 border rounded", value: formData.name, onChange: e => setFormData({...formData, name: e.target.value}) })
                    ),
                    React.createElement("input", { placeholder: "Satuan", className: "w-full p-2 border rounded", value: formData.uom, onChange: e => setFormData({...formData, uom: e.target.value}) }), React.createElement("textarea", { placeholder: "Keterangan", className: "w-full p-2 border rounded", value: formData.notes, onChange: e => setFormData({...formData, notes: e.target.value}) }), 
                React.createElement("button", { type: "submit", disabled: isSubmitting, className: "w-full bg-slate-800 text-white p-2 rounded disabled:opacity-50" }, isSubmitting ? "Menyimpan..." : "Simpan"))),
                React.createElement("div", { className: "bg-white p-4 rounded-xl border" }, React.createElement("h3", { className: "font-bold mb-4" }, "Daftar Barang"), React.createElement("div", { className: "overflow-x-auto" }, React.createElement("table", { className: "w-full text-sm text-left" }, React.createElement("thead", { className: "bg-slate-50 font-bold" }, React.createElement("tr", null, React.createElement("th", {className:"p-3"}, "Kode"), React.createElement("th", {className:"p-3"}, "Nama"), React.createElement("th", {className:"p-3"}, "UoM"), React.createElement("th", {className:"p-3"}, "Ket"), React.createElement("th", {className:"p-3"}, "Aksi"))), React.createElement("tbody", null, items.map(i => editingId === i.id ? React.createElement("tr", { key: i.id }, React.createElement("td", {className:"p-2"}, React.createElement("input", {value: editData.code, onChange: e=>setEditData({...editData, code:e.target.value})})), React.createElement("td", {className:"p-2"}, React.createElement("input", {value: editData.name, onChange: e=>setEditData({...editData, name:e.target.value})})), React.createElement("td", {className:"p-2"}, React.createElement("input", {value: editData.uom, onChange: e=>setEditData({...editData, uom:e.target.value})})), React.createElement("td", {className:"p-2"}, React.createElement("input", {value: editData.notes, onChange: e=>setEditData({...editData, notes:e.target.value})})), React.createElement("td", {className:"p-2"}, React.createElement("button", {onClick: saveEdit}, "Simpan"))) : React.createElement("tr", { key: i.id, className: "border-b" }, React.createElement("td", {className:"p-3 font-mono text-xs text-slate-500"}, i.code || '-'), React.createElement("td", {className:"p-3"}, i.name), React.createElement("td", {className:"p-3"}, i.uom), React.createElement("td", {className:"p-3"}, i.notes), React.createElement("td", {className:"p-3"}, React.createElement("button", {onClick: ()=> {setEditingId(i.id); setEditData(i)}}, "Edit"), React.createElement("button", {onClick: ()=>deleteItem(i.id), className:"ml-2 text-red-500"}, "Hapus"))))))))
            );
        };

        const RegisterTruckForm = ({ user, trucks }) => {
            const [formData, setFormData] = useState({ 
                nopol: '', 
                driver: '', 
                noHp: '', 
                type: 'CDD',
                ticketNumber: '', 
                netWeight: ''      
            });
            const [editingId, setEditingId] = useState(null);
            const [editData, setEditData] = useState({});
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if(!formData.nopol || !formData.driver) {
                    return alert("Mohon lengkapi No Polisi dan Nama Driver!");
                }

                setIsSubmitting(true);
                if (!auth.currentUser) {
                    try { await signInAnonymously(auth); } catch(e) { console.error("Reconnect failed"); }
                }

                try {
                    // LOGIC BARU: Default status 'AVAILABLE'
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'trucks'), { 
                        ...formData, 
                        nopol: formData.nopol.toUpperCase(), 
                        status: 'AVAILABLE', // Status awal
                        createdAt: serverTimestamp() 
                    });
                    setFormData({ nopol: '', driver: '', noHp: '', type: 'CDD', ticketNumber: '', netWeight: '' });
                    alert("Armada berhasil disimpan!");
                } catch (error) {
                    console.error("Error saving truck:", error);
                    if (error.code === 'permission-denied') {
                        alert("⛔ GAGAL MENYIMPAN: IZIN DITOLAK FIREBASE");
                    } else {
                        alert("Gagal menyimpan: " + error.message);
                    }
                } finally {
                    setIsSubmitting(false);
                }
            };

            const startEdit = (truck) => {
                const password = prompt("Masukkan Password Admin untuk Edit Armada:");
                if (password !== 'admin123') {
                    alert("Password Salah! Akses ditolak.");
                    return;
                }
                setEditingId(truck.id);
                setEditData(truck);
            };

            const cancelEdit = () => {
                setEditingId(null);
                setEditData({});
            };

            const saveEdit = async () => {
                if(!editData.nopol || !editData.driver) return alert("Data tidak boleh kosong!");
                
                if (!auth.currentUser) {
                    try { await signInAnonymously(auth); } catch(e) { console.error("Reconnect failed"); }
                }

                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trucks', editingId), {
                        nopol: editData.nopol.toUpperCase(),
                        driver: editData.driver,
                        noHp: editData.noHp,
                        type: editData.type,
                        ticketNumber: editData.ticketNumber || '', 
                        netWeight: editData.netWeight || ''       
                    });
                    setEditingId(null);
                    alert("Perubahan berhasil disimpan!");
                } catch (err) {
                    console.error("Gagal update:", err);
                    alert("Gagal update data: " + err.message);
                }
            };

            const deleteTruck = async (id) => {
                const password = prompt("Masukkan Password Admin untuk Hapus Armada:");
                if (password !== 'admin123') {
                    alert("Password Salah! Akses ditolak.");
                    return;
                }

                if(confirm("Yakin hapus armada ini?")) {
                    if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'trucks', id));
                }
            };

            return React.createElement("div", { className: "space-y-6 no-print" },
                React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border shadow-sm" },
                    React.createElement("h2", { className: "font-bold mb-4 flex gap-2 items-center" }, React.createElement(PlusCircle, { className: "text-blue-500" }), " Registrasi Armada Pengiriman"),
                    React.createElement("form", { onSubmit: handleSubmit, className: "space-y-3" },
                        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
                            React.createElement("input", { required: true, placeholder: "No Polisi (Contoh: B 1234 XX)", className: "w-full p-2 border rounded-lg uppercase", value: formData.nopol, onChange: e => setFormData({...formData, nopol: e.target.value}) }),
                            React.createElement("select", { className: "w-full p-2 border rounded-lg", value: formData.type, onChange: e => setFormData({...formData, type: e.target.value}) }, 
                                TRUCK_TYPES.map(t => React.createElement("option", { key: t, value: t }, t))
                            )
                        ),
                        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3" },
                            React.createElement("input", { required: true, placeholder: "Nama Driver", className: "w-full p-2 border rounded-lg", value: formData.driver, onChange: e => setFormData({...formData, driver: e.target.value}) }),
                            React.createElement("input", { type: "tel", placeholder: "No HP Driver", className: "w-full p-2 border rounded-lg", value: formData.noHp, onChange: e => setFormData({...formData, noHp: e.target.value}) })
                        ),
                        
                        // NEW INPUT FIELDS
                        React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-3 pt-2 border-t" },
                            React.createElement("div", { className: "relative" },
                                React.createElement(Receipt, { className: "absolute left-3 top-3 text-slate-400", size: 18 }),
                                React.createElement("input", { 
                                    placeholder: "No Tiket Timbangan", 
                                    className: "w-full p-2 pl-10 border rounded-lg bg-yellow-50", 
                                    value: formData.ticketNumber, 
                                    onChange: e => setFormData({...formData, ticketNumber: e.target.value}) 
                                })
                            ),
                            React.createElement("div", { className: "relative" },
                                React.createElement(Scale, { className: "absolute left-3 top-3 text-slate-400", size: 18 }),
                                React.createElement("input", { 
                                    type: "number", 
                                    placeholder: "Qty Net Timbangan (Kg)", 
                                    className: "w-full p-2 pl-10 border rounded-lg bg-yellow-50", 
                                    value: formData.netWeight, 
                                    onChange: e => setFormData({...formData, netWeight: e.target.value}) 
                                })
                            )
                        ),

                        React.createElement("button", { 
                            type: "submit", 
                            disabled: isSubmitting,
                            className: "w-full bg-blue-600 text-white p-2 rounded-lg font-bold hover:bg-blue-700 transition-colors disabled:opacity-50" 
                        }, isSubmitting ? "Menyimpan..." : "Simpan Armada")
                    )
                ),

                React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border shadow-sm" },
                    React.createElement("h2", { className: "font-bold mb-4 flex gap-2 items-center" }, React.createElement(Truck, { className: "text-blue-500" }), " Daftar Armada"),
                    React.createElement("div", { className: "overflow-x-auto" },
                        React.createElement("table", { className: "w-full text-sm text-left whitespace-nowrap" },
                            React.createElement("thead", { className: "bg-slate-50 text-slate-500 uppercase font-bold" },
                                React.createElement("tr", null,
                                    React.createElement("th", { className: "p-3" }, "No Polisi"),
                                    React.createElement("th", { className: "p-3" }, "Driver"),
                                    React.createElement("th", { className: "p-3" }, "No Tiket"),
                                    React.createElement("th", { className: "p-3" }, "Qty Net"),
                                    React.createElement("th", { className: "p-3" }, "Status"),
                                    React.createElement("th", { className: "p-3" }, "Tipe"),
                                    React.createElement("th", { className: "p-3 text-right" }, "Aksi")
                                )
                            ),
                            React.createElement("tbody", null,
                                trucks.length === 0 ? 
                                React.createElement("tr", null, React.createElement("td", { colSpan: 7, className: "p-4 text-center text-slate-400" }, "Belum ada armada terdaftar.")) :
                                trucks.map(t => 
                                    editingId === t.id ? 
                                    React.createElement("tr", { key: t.id, className: "border-b bg-blue-50" },
                                        React.createElement("td", { className: "p-2" }, 
                                            React.createElement("input", { className: "w-full p-1 border rounded uppercase font-bold", value: editData.nopol, onChange: e => setEditData({...editData, nopol: e.target.value}) })
                                        ),
                                        React.createElement("td", { className: "p-2" }, 
                                            React.createElement("input", { className: "w-full p-1 border rounded", value: editData.driver, onChange: e => setEditData({...editData, driver: e.target.value}) })
                                        ),
                                        React.createElement("td", { className: "p-2" }, 
                                            React.createElement("input", { className: "w-full p-1 border rounded", value: editData.ticketNumber, onChange: e => setEditData({...editData, ticketNumber: e.target.value}) })
                                        ),
                                        React.createElement("td", { className: "p-2" }, 
                                            React.createElement("input", { type: "number", className: "w-full p-1 border rounded", value: editData.netWeight, onChange: e => setEditData({...editData, netWeight: e.target.value}) })
                                        ),
                                        React.createElement("td", { className: "p-2" }, "-"),
                                        React.createElement("td", { className: "p-2" }, 
                                            React.createElement("select", { className: "w-full p-1 border rounded", value: editData.type, onChange: e => setEditData({...editData, type: e.target.value}) },
                                                TRUCK_TYPES.map(type => React.createElement("option", { key: type, value: type }, type))
                                            )
                                        ),
                                        React.createElement("td", { className: "p-2 text-right flex justify-end gap-2" }, 
                                            React.createElement("button", { onClick: saveEdit, className: "p-1 bg-green-500 text-white rounded hover:bg-green-600" }, React.createElement(CheckCircle, { size: 16 })),
                                            React.createElement("button", { onClick: cancelEdit, className: "p-1 bg-red-400 text-white rounded hover:bg-red-500" }, React.createElement(X, { size: 16 }))
                                        )
                                    ) :
                                    React.createElement("tr", { key: t.id, className: "border-b hover:bg-slate-50" },
                                        React.createElement("td", { className: "p-3 font-bold" }, t.nopol),
                                        React.createElement("td", { className: "p-3" }, t.driver),
                                        React.createElement("td", { className: "p-3 text-slate-500 font-mono text-xs" }, t.ticketNumber || '-'),
                                        React.createElement("td", { className: "p-3 font-mono" }, t.netWeight ? `${t.netWeight} Kg` : '-'),
                                        React.createElement("td", { className: "p-3" }, 
                                             t.status === 'BUSY' ? 
                                             React.createElement("span", { className: "bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold" }, "BUSY") :
                                             React.createElement("span", { className: "bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold" }, "AVAILABLE")
                                        ),
                                        React.createElement("td", { className: "p-3" }, 
                                            React.createElement("span", { className: "bg-slate-200 px-2 py-1 rounded text-xs font-bold" }, t.type)
                                        ),
                                        React.createElement("td", { className: "p-3 text-right flex justify-end gap-2" }, 
                                            React.createElement("button", { onClick: () => startEdit(t), className: "text-blue-500 hover:text-blue-700" }, React.createElement(Pencil, { size: 16 })),
                                            React.createElement("button", { onClick: () => deleteTruck(t.id), className: "text-red-400 hover:text-red-600" }, React.createElement(Trash2, { size: 16 }))
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        const SettingsPage = ({ user }) => {
            const [activeTab, setActiveTab] = useState('general');
            const [coords, setCoords] = useState(DEFAULT_COORDS);
            const [waConfig, setWaConfig] = useState({ token: '', targetGroups: '' });
            const [loading, setLoading] = useState(false);
            const [isResetting, setIsResetting] = useState(false);
            
            // User Management State
            const [usersList, setUsersList] = useState([]);
            const [newUser, setNewUser] = useState({ username: '', password: '', role: 'user', menus: [] });
            const [editingPassId, setEditingPassId] = useState(null);
            const [newPass, setNewPass] = useState('');

            const AVAILABLE_MENUS = [
                { id: 'transaction', label: 'Transaksi' },
                { id: 'history', label: 'Riwayat' },
                { id: 'tracking', label: 'Live Tracking' },
                { id: 'recap', label: 'Rekap' },
                { id: 'register', label: 'Armada' },
                { id: 'customers', label: 'Customer' },
                { id: 'transporters', label: 'Transporter' },
                { id: 'items', label: 'Barang' }
                // { id: 'instruction', label: 'Panduan' } // DIHAPUS
            ];

            useEffect(() => {
                if (!user) return;
                
                // Load Settings
                const loadSettings = async () => {
                    const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'));
                    if (snap.exists()) {
                        const data = snap.data();
                        if(data.printConfig) setCoords(data.printConfig);
                        if(data.waConfig) setWaConfig(data.waConfig);
                    }
                };
                loadSettings();

                // Load Users List
                const unsubUsers = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'users')), s => {
                    setUsersList(s.docs.map(d => ({id: d.id, ...d.data()})));
                });
                
                return () => unsubUsers();
            }, [user]);

            const saveSettings = async () => {
                setLoading(true);
                // FIX: Auto-reconnect
                if (!auth.currentUser) {
                    try { await signInAnonymously(auth); } catch(e) { console.error("Reconnect failed"); }
                }
                
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), {
                        printConfig: coords,
                        waConfig: waConfig,
                        updatedAt: serverTimestamp()
                    }, { merge: true });
                    alert("Pengaturan Berhasil Disimpan!");
                } catch (err) {
                    console.error(err);
                    alert("Gagal menyimpan");
                }
                setLoading(false);
            };

            // FUNGSI BARU: TEST KIRIM WA
            const handleTestWA = async () => {
                if (!waConfig.token || !waConfig.targetGroups) {
                    return alert("Mohon isi Token dan Target Group terlebih dahulu!");
                }

                setLoading(true);
                try {
                    const formData = new FormData();
                    formData.append('target', waConfig.targetGroups);
                    formData.append('message', "*Tes Notifikasi MyTrading*\n\n✅ Koneksi WhatsApp Gateway Berhasil!\nSistem siap mengirim laporan transaksi.");
                    
                    const response = await fetch("https://api.fonnte.com/send", {
                        method: 'POST',
                        headers: {
                            'Authorization': waConfig.token
                        },
                        body: formData
                    });

                    const result = await response.json();
                    console.log("Test WA Result:", result);

                    if (result.status) {
                        alert("Sukses! Pesan tes telah dikirim ke WhatsApp Group.");
                    } else {
                        alert(`Gagal: ${result.reason || 'Cek Token atau ID Group Anda'}`);
                    }
                } catch (error) {
                    console.error("Test WA Error:", error);
                    alert("Error Jaringan: " + error.message);
                }
                setLoading(false);
            };

            // User Management Functions
            const toggleMenu = (menuId) => {
                setNewUser(prev => {
                    if (prev.menus.includes(menuId)) {
                        return { ...prev, menus: prev.menus.filter(m => m !== menuId) };
                    } else {
                        return { ...prev, menus: [...prev.menus, menuId] };
                    }
                });
            }

            const handleAddUser = async (e) => {
                e.preventDefault();
                if (!newUser.username || !newUser.password) return alert("Username dan Password wajib diisi");
                
                // FIX: Validasi Duplicate Username
                const exists = usersList.some(u => u.username.toLowerCase() === newUser.username.toLowerCase());
                if(exists) return alert("Gagal: Username sudah terdaftar! Gunakan yang lain.");

                setLoading(true); 
                
                // FIX: Auto-reconnect
                if (!auth.currentUser) {
                    try { await signInAnonymously(auth); } catch(e) { console.error("Reconnect failed"); }
                }

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), {
                        ...newUser,
                        createdAt: serverTimestamp()
                    });
                    setNewUser({ username: '', password: '', role: 'user', menus: [] });
                    alert("User berhasil ditambahkan");
                } catch (err) {
                    console.error(err);
                    alert("Gagal menambah user: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleDeleteUser = async (id) => {
                if(!confirm("Yakin hapus user ini?")) return;
                
                if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }

                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id));
                } catch(err) {
                    console.error(err);
                    alert("Gagal menghapus user: " + err.message);
                }
            };

            const handleChangePassword = async (id) => {
                if(!newPass) return alert("Password tidak boleh kosong");
                
                if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }

                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), {
                        password: newPass
                    });
                    setEditingPassId(null);
                    setNewPass('');
                    alert("Password berhasil diubah");
                } catch(err) {
                    console.error(err);
                    alert("Gagal mengubah password: " + err.message);
                }
            };

            // Existing Reset Functions
            const handleResetTransactions = async () => {
                if (!confirm("PERINGATAN KERAS:\nAnda akan menghapus SEMUA DATA RIWAYAT TRANSAKSI.\nData yang dihapus TIDAK BISA DIKEMBALIKAN.\n\nKlik OK jika Anda yakin.")) return;
                if (!confirm("Apakah Anda benar-benar yakin ingin mengosongkan data transaksi?")) return;

                setIsResetting(true);
                
                if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }

                try {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'));
                    const snapshot = await getDocs(q); 
                    const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    alert("Semua data transaksi berhasil dihapus.");
                } catch (error) {
                    console.error("Error resetting transactions:", error);
                    alert("Gagal menghapus data: " + error.message);
                }
                setIsResetting(false);
            };

            const handleResetMasterData = async () => {
                 if (!confirm("PERINGATAN KERAS:\nAnda akan menghapus SEMUA DATA MASTER (Customer, Barang, Armada).\nAnda harus menginput ulang data dari awal.\n\nLanjutkan?")) return;
                 if (!confirm("Yakin hapus Master Data?")) return;

                 setIsResetting(true);
                 
                 if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) {} }

                 try {
                    const collections = ['customers', 'items', 'trucks'];
                    for (const colName of collections) {
                        const q = query(collection(db, 'artifacts', appId, 'public', 'data', colName));
                        const s = await getDocs(q);
                        const p = s.docs.map(d => deleteDoc(d.ref));
                        await Promise.all(p);
                    }
                    alert("Semua master data berhasil dihapus.");
                 } catch (error) {
                     console.error(error);
                     alert("Gagal reset master data.");
                 }
                 setIsResetting(false);
            }

            return React.createElement("div", { className: "bg-white p-4 md:p-6 rounded-xl border shadow-sm no-print space-y-6" },
                React.createElement("h2", { className: "text-lg font-bold flex items-center gap-2 border-b pb-4" }, 
                    React.createElement(Settings, { className: "text-blue-500" }), " Pengaturan Aplikasi"
                ),
                
                React.createElement("div", { className: "flex gap-2 border-b overflow-x-auto hide-scrollbar" },
                    React.createElement("button", { onClick: () => setActiveTab('general'), className: `px-4 py-2 border-b-2 font-bold whitespace-nowrap ${activeTab === 'general' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-400'}` }, "Umum"),
                    React.createElement("button", { onClick: () => setActiveTab('users'), className: `px-4 py-2 border-b-2 font-bold whitespace-nowrap ${activeTab === 'users' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-400'}` }, "Manajemen User"),
                    React.createElement("button", { onClick: () => setActiveTab('wa'), className: `px-4 py-2 border-b-2 font-bold whitespace-nowrap ${activeTab === 'wa' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-400'}` }, "WhatsApp"),
                    React.createElement("button", { onClick: () => setActiveTab('print'), className: `px-4 py-2 border-b-2 font-bold whitespace-nowrap ${activeTab === 'print' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-400'}` }, "Kalibrasi Cetak"),
                    React.createElement("button", { onClick: () => setActiveTab('reset'), className: `px-4 py-2 border-b-2 font-bold whitespace-nowrap ${activeTab === 'reset' ? 'border-red-500 text-red-600' : 'border-transparent text-slate-400'}` }, "Reset Data")
                ),

                activeTab === 'general' && React.createElement("div", { className: "text-center py-8" },
                    // LOGO SETTINGS: Background Merah, Icon Hijau Bold
                    React.createElement("div", { className: "w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4" },
                        React.createElement(TrendingUp, { className: "text-green-600", size: 32, strokeWidth: 3 })
                    ),
                    // TEXT SETTINGS: Gold Pekat
                    React.createElement("h3", {className: "font-bold text-lg text-[#B8860B]"}, "MyTrading v1.4.3"),
                    React.createElement("p", { className: "text-blue-600 text-sm" }, "Smart Trading Logistics Management")
                ),

                // USER MANAGEMENT TAB
                activeTab === 'users' && React.createElement("div", { className: "space-y-6" },
                    // Form Tambah User
                    React.createElement("div", { className: "bg-slate-50 p-4 rounded-lg border border-slate-200" },
                        React.createElement("h3", { className: "font-bold text-sm mb-3 flex items-center gap-2" }, 
                            React.createElement(UserPlus, { size: 16 }), "Tambah User Baru"
                        ),
                        React.createElement("form", { onSubmit: handleAddUser, className: "flex flex-col gap-3" },
                            React.createElement("div", { className: "flex flex-col md:flex-row gap-3" },
                                React.createElement("input", { 
                                    placeholder: "Username", 
                                    className: "p-2 border rounded text-sm flex-1", 
                                    value: newUser.username, 
                                    onChange: e => setNewUser({...newUser, username: e.target.value}) 
                                }),
                                React.createElement("input", { 
                                    type: "text", 
                                    placeholder: "Password", 
                                    className: "p-2 border rounded text-sm flex-1", 
                                    value: newUser.password, 
                                    onChange: e => setNewUser({...newUser, password: e.target.value}) 
                                }),
                                React.createElement("select", { 
                                    className: "p-2 border rounded text-sm w-full md:w-32", 
                                    value: newUser.role, 
                                    onChange: e => setNewUser({...newUser, role: e.target.value}) 
                                },
                                    React.createElement("option", { value: "user" }, "User"),
                                    React.createElement("option", { value: "admin" }, "Admin"),
                                    React.createElement("option", { value: "timbang" }, "Timbang")
                                ),
                                React.createElement("button", { 
                                    type: "submit", 
                                    disabled: loading,
                                    className: "bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 disabled:opacity-50" 
                                }, loading ? "Menyimpan..." : "Tambah")
                            ),
                            // MENU SELECTION CHECKBOXES
                            React.createElement("div", { className: "w-full mt-2 p-3 bg-white rounded border border-slate-200" },
                                React.createElement("p", { className: "text-xs font-bold text-slate-500 mb-2 flex items-center gap-1" }, 
                                    React.createElement(Menu, { size: 12 }), "AKSES MENU:"
                                ),
                                React.createElement("div", { className: "grid grid-cols-2 md:grid-cols-4 gap-2" },
                                    AVAILABLE_MENUS.map(m => (
                                        React.createElement("label", { key: m.id, className: "flex items-center gap-2 text-xs cursor-pointer select-none" },
                                            React.createElement("input", { 
                                                type: "checkbox", 
                                                checked: newUser.menus.includes(m.id), 
                                                onChange: () => toggleMenu(m.id),
                                                className: "accent-blue-600 rounded"
                                            }),
                                            m.label
                                        )
                                    ))
                                )
                            )
                        )
                    ),
                    
                    // List User
                    React.createElement("div", { className: "overflow-x-auto" },
                        React.createElement("table", { className: "w-full text-sm text-left border rounded-lg overflow-hidden" },
                            React.createElement("thead", { className: "bg-slate-100 font-bold" },
                                React.createElement("tr", null,
                                    React.createElement("th", { className: "p-3" }, "Username"),
                                    React.createElement("th", { className: "p-3" }, "Role"),
                                    React.createElement("th", { className: "p-3" }, "Password"),
                                    React.createElement("th", { className: "p-3 text-right" }, "Aksi")
                                )
                            ),
                            React.createElement("tbody", { className: "divide-y" },
                                usersList.map(u => 
                                    React.createElement("tr", { key: u.id },
                                        React.createElement("td", { className: "p-3 font-medium" }, 
                                            u.username,
                                            // Show indicator if custom menus set
                                            u.menus && u.menus.length > 0 && React.createElement("span", { className: "ml-2 text-[10px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded" }, "Custom Menu")
                                        ),
                                        React.createElement("td", { className: "p-3" }, 
                                            React.createElement("span", { className: "bg-slate-100 px-2 py-1 rounded text-xs uppercase font-bold text-slate-600" }, u.role)
                                        ),
                                        React.createElement("td", { className: "p-3" }, 
                                            editingPassId === u.id ? 
                                            React.createElement("div", { className: "flex gap-2" },
                                                React.createElement("input", { 
                                                    className: "border p-1 rounded w-32", 
                                                    value: newPass, 
                                                    onChange: e => setNewPass(e.target.value),
                                                    placeholder: "Password Baru" 
                                                }),
                                                React.createElement("button", { onClick: () => handleChangePassword(u.id), className: "text-green-600 font-bold" }, "OK"),
                                                React.createElement("button", { onClick: () => setEditingPassId(null), className: "text-slate-400" }, "X")
                                            ) : 
                                            "******"
                                        ),
                                        React.createElement("td", { className: "p-3 text-right flex justify-end gap-3" },
                                            React.createElement("button", { 
                                                onClick: () => { setEditingPassId(u.id); setNewPass(''); }, 
                                                className: "text-blue-500 hover:text-blue-700 text-xs flex items-center gap-1",
                                                title: "Ganti Password"
                                            }, React.createElement(Key, { size: 14 }), "Ubah Pass"),
                                            React.createElement("button", { 
                                                onClick: () => handleDeleteUser(u.id), 
                                                className: "text-red-400 hover:text-red-600 text-xs flex items-center gap-1",
                                                title: "Hapus User"
                                            }, React.createElement(Trash2, { size: 14 }), "Hapus")
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),

                activeTab === 'wa' && React.createElement("div", { className: "space-y-4" },
                    React.createElement("div", { className: "bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-xs text-yellow-800" }, 
                        "Sistem menggunakan API Fonnte untuk mengirim notifikasi WhatsApp. Pastikan token aktif."
                    ),
                    React.createElement("div", null,
                        React.createElement("label", { className: "block text-xs font-bold text-slate-500 mb-1" }, "TOKEN FONNTE"),
                        React.createElement("input", { 
                            type: "text", 
                            placeholder: "Masukkan Token Fonnte...", 
                            className: "w-full p-2 border rounded-lg",
                            value: waConfig.token,
                            onChange: e => setWaConfig({...waConfig, token: e.target.value})
                        })
                    ),
                    React.createElement("div", null,
                        React.createElement("label", { className: "block text-xs font-bold text-slate-500 mb-1" }, "ID GROUP WHATSAPP (Pisahkan koma jika > 1)"),
                        React.createElement("input", { 
                            type: "text", 
                            placeholder: "1203630234@g.us, 1203630999@g.us", 
                            className: "w-full p-2 border rounded-lg",
                            value: waConfig.targetGroups,
                            onChange: e => setWaConfig({...waConfig, targetGroups: e.target.value})
                        })
                    ),
                    // Tampilan Tombol Simpan & Tes
                    React.createElement("div", { className: "flex gap-3 pt-2" },
                        React.createElement("button", { onClick: saveSettings, disabled: loading, className: "bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2" }, 
                            loading ? "Menyimpan..." : React.createElement(React.Fragment, null, React.createElement(Save, {size:18}), "Simpan Konfigurasi")
                        ),
                        React.createElement("button", { onClick: handleTestWA, disabled: loading, className: "bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50 flex items-center gap-2" }, 
                            loading ? "Mengirim..." : React.createElement(React.Fragment, null, React.createElement(Send, {size:18}), "Tes Kirim Pesan")
                        )
                    )
                ),

                activeTab === 'print' && React.createElement("div", { className: "space-y-4" },
                    React.createElement("p", { className: "text-sm text-slate-500" }, "Atur koordinat (dalam milimeter) untuk posisi cetak pada blangko kosong."),
                    React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                        Object.entries(coords).map(([key, val]) => 
                            React.createElement("div", { key: key, className: "border p-3 rounded-lg bg-slate-50" },
                                React.createElement("p", { className: "font-bold text-sm mb-2" }, val.label),
                                React.createElement("div", { className: "flex gap-2" },
                                    React.createElement("div", { className: "flex-1" },
                                        React.createElement("label", { className: "text-[10px] text-slate-400 block" }, "ATAS (Y) mm"),
                                        React.createElement("input", { 
                                            type: "number", 
                                            className: "w-full p-1 border rounded", 
                                            value: val.top,
                                            onChange: e => setCoords({ ...coords, [key]: { ...val, top: Number(e.target.value) } })
                                        })
                                    ),
                                    React.createElement("div", { className: "flex-1" },
                                        React.createElement("label", { className: "text-[10px] text-slate-400 block" }, "KIRI (X) mm"),
                                        React.createElement("input", { 
                                            type: "number", 
                                            className: "w-full p-1 border rounded", 
                                            value: val.left,
                                            onChange: e => setCoords({ ...coords, [key]: { ...val, left: Number(e.target.value) } })
                                        })
                                    )
                                )
                            )
                        )
                    ),
                    React.createElement("button", { onClick: saveSettings, disabled: loading, className: "bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 mt-4 w-full md:w-auto" }, 
                        loading ? "Menyimpan..." : "Simpan Koordinat"
                    )
                ),

                // RESET DATA TAB
                activeTab === 'reset' && React.createElement("div", { className: "space-y-6" },
                    React.createElement("div", { className: "bg-red-50 border border-red-200 p-4 rounded-lg flex gap-3 items-start" },
                        React.createElement(AlertTriangle, { className: "text-red-600 shrink-0 mt-1" }),
                        React.createElement("div", null,
                            React.createElement("h3", { className: "font-bold text-red-800" }, "Zona Bahaya (Danger Zone)"),
                            React.createElement("p", { className: "text-sm text-red-700 mt-1" }, 
                                "Tindakan di halaman ini bersifat destruktif dan tidak dapat dibatalkan. Data yang dihapus akan hilang selamanya."
                            )
                        )
                    ),

                    React.createElement("div", { className: "space-y-4" },
                        React.createElement("div", { className: "border p-4 rounded-lg flex flex-col md:flex-row justify-between items-center gap-4 bg-white" },
                            React.createElement("div", null,
                                React.createElement("h4", { className: "font-bold" }, "Reset Data Transaksi"),
                                React.createElement("p", { className: "text-xs text-slate-500" }, "Menghapus semua riwayat transaksi pengiriman. Data Customer, Barang, & Armada TETAP ADA.")
                            ),
                            React.createElement("button", { 
                                onClick: handleResetTransactions, 
                                disabled: isResetting,
                                className: "bg-red-100 text-red-700 px-4 py-2 rounded-lg font-bold hover:bg-red-200 border border-red-200 whitespace-nowrap disabled:opacity-50" 
                            }, isResetting ? "Memproses..." : "Hapus Semua Transaksi")
                        ),

                        React.createElement("div", { className: "border p-4 rounded-lg flex flex-col md:flex-row justify-between items-center gap-4 bg-white" },
                            React.createElement("div", null,
                                React.createElement("h4", { className: "font-bold" }, "Reset Master Data (Total Reset)"),
                                React.createElement("p", { className: "text-xs text-slate-500" }, "Menghapus Customer, Barang, dan Armada. Aplikasi akan menjadi kosong melompong.")
                            ),
                            React.createElement("button", { 
                                onClick: handleResetMasterData, 
                                disabled: isResetting,
                                className: "bg-slate-100 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-200 border border-slate-300 whitespace-nowrap disabled:opacity-50" 
                            }, isResetting ? "Memproses..." : "Hapus Master Data")
                        )
                    )
                )
            );
        };

        // KOMPONEN PERINGATAN MOBILE
        const MobileWarning = () => {
            const [visible, setVisible] = useState(false);

            useEffect(() => {
                // Cek lebar layar saat load (md breakpoint tailwind adalah 768px)
                if (window.innerWidth < 768) {
                    setVisible(true);
                }
            }, []);

            if (!visible) return null;

            return React.createElement("div", { className: "fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/90 p-6 backdrop-blur-sm no-print transition-all duration-300" },
                React.createElement("div", { className: "bg-white rounded-2xl p-6 max-w-xs w-full text-center shadow-2xl border border-slate-200 transform scale-100 transition-transform" },
                    React.createElement("div", { className: "w-14 h-14 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-amber-50" },
                        React.createElement(AlertTriangle, { className: "text-amber-600", size: 28 })
                    ),
                    React.createElement("h3", { className: "text-lg font-bold text-slate-800 mb-2" }, "Optimized for PC"),
                    React.createElement("p", { className: "text-sm text-slate-500 mb-6 leading-relaxed" }, 
                        "Aplikasi ini didesain khusus untuk Laptop/PC. Tampilan di HP mungkin terbatas dan hanya disarankan untuk akses menu Armada."
                    ),
                    React.createElement("button", { 
                        onClick: () => setVisible(false),
                        className: "w-full bg-slate-800 text-white font-bold py-3 rounded-xl hover:bg-slate-700 active:scale-95 transition-all text-sm shadow-lg shadow-slate-200"
                    }, "Mengerti, Lanjutkan")
                )
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            // Change userRole state to store full user data
            const [userData, setUserData] = useState(null); 
            const [view, setView] = useState('transaction'); 
            const [loading, setLoading] = useState(true);
            const [trucks, setTrucks] = useState([]); 

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth error:", error);
                    }
                };
                initAuth();

                // Seed Default Users if DB is Empty
                const seedUsers = async () => {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
                    const snap = await getDocs(q);
                    if(snap.empty) {
                        console.log("Seeding default users...");
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), {username: 'admin', password: 'admin123', role: 'admin'});
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), {username: 'user', password: 'user123', role: 'user'});
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), {username: 'timbang', password: 'timbang123', role: 'timbang'});
                    }
                }
                
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                    if(u) seedUsers();
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const qT = query(collection(db, 'artifacts', appId, 'public', 'data', 'trucks'));
                const unsub = onSnapshot(qT, s => setTrucks(s.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => unsub();
            }, [user]);

            // Jika belum login ke "App Role", tampilkan login screen
            if (!userData) {
                return React.createElement(LoginScreen, { 
                    onLogin: (data) => {
                        setUserData(data);
                        // Set view default berdasarkan role atau menu pertama yang diizinkan
                        if (data.role === 'admin') {
                            setView('transaction'); 
                        } else if (data.menus && data.menus.length > 0) {
                            setView(data.menus[0]);
                        } else if (data.role === 'user') {
                            setView('transaction');
                        } else if (data.role === 'timbang') {
                            setView('register');
                        }
                    } 
                });
            }

            if (loading) return React.createElement('div', { className: "flex flex-col items-center justify-center h-screen bg-white" },
                React.createElement("div", { className: "relative flex items-center justify-center w-24 h-24 mb-8" },
                    // LOADING SPINNER: Theme matched
                    React.createElement("div", { className: "absolute inset-0 border-4 border-red-100 rounded-full" }),
                    React.createElement("div", { className: "absolute inset-0 border-4 border-green-600 rounded-full border-t-transparent animate-spin" }),
                    React.createElement(TrendingUp, { className: "text-green-600", size: 32, strokeWidth: 3 })
                ),
                // LOADING TEXT: Gold Pekat
                React.createElement("h2", { className: "text-2xl font-black text-[#B8860B] mb-2 tracking-tight" }, "MyTrading"),
                React.createElement("p", { className: "text-slate-500 font-medium animate-pulse" }, "Pengalihan server Mytrading MyScm..."),
                React.createElement("div", { className: "mt-8 flex gap-2" },
                    [0,1,2].map(i => React.createElement("div", { key: i, className: "w-2 h-2 bg-green-600 rounded-full animate-bounce", style: { animationDelay: `${i * 0.1}s` } }))
                )
            );

            // Konfigurasi Menu berdasarkan Role
            const allMenuItems = [
                {v: 'transaction', i: ClipboardList, l: 'Transaksi'},
                {v: 'history', i: History, l: 'Riwayat'},
                {v: 'tracking', i: MapPin, l: 'Live Tracking'}, // NEW MENU ITEM
                {v: 'recap', i: FileSpreadsheet, l: 'Rekap'}, 
                {v: 'register', i: Truck, l: 'Armada'},
                {v: 'customers', i: Users, l: 'Customer'},
                {v: 'transporters', i: Briefcase, l: 'Transporter'}, 
                {v: 'items', i: Package, l: 'Barang'}
                // {v: 'instruction', i: Info, l: 'Panduan'} // DIHAPUS
            ];

            // Filter Menu Logic
            let menuItems = [];
            const userRole = userData.role;

            if (userRole === 'admin') {
                menuItems = allMenuItems;
            } else if (userData.menus && Array.isArray(userData.menus) && userData.menus.length > 0) {
                // Jika user memiliki properti 'menus' khusus, gunakan itu
                menuItems = allMenuItems.filter(item => userData.menus.includes(item.v));
            } else {
                // Fallback ke logika role lama jika tidak ada custom menu
                if (userRole === 'user') {
                    // User: Transaksi, Tracking, & Rekap
                    menuItems = allMenuItems.filter(item => item.v === 'transaction' || item.v === 'tracking' || item.v === 'recap');
                } else if (userRole === 'timbang') {
                    menuItems = allMenuItems.filter(item => item.v === 'register');
                }
            }

            return (
                React.createElement("div", { className: "min-h-screen bg-slate-100 flex flex-col md:flex-row" },
                    // Tampilkan Warning jika Mobile
                    React.createElement(MobileWarning),

                    // SIDEBAR (Now visible on all devices, adjusted for responsive behavior)
                    React.createElement("aside", { className: "flex flex-col w-full md:w-64 bg-sky-50 border-b md:border-b-0 md:border-r border-sky-100 text-slate-700 md:h-screen md:sticky top-0 no-print z-10 shrink-0" },
                        // Logo
                        React.createElement("div", { className: "h-16 flex items-center px-6 border-b border-sky-200 bg-sky-100/50 justify-between md:justify-start" },
                             // SIDEBAR LOGO: Background Merah, Icon Hijau Bold
                             React.createElement("div", { className: "flex items-center" },
                                 React.createElement("div", { className: "w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-3" },
                                    React.createElement(TrendingUp, { className: "text-green-600", size: 20, strokeWidth: 3 })
                                 ),
                                 React.createElement("div", null,
                                    // SIDEBAR TEXT: Gold Pekat
                                    React.createElement("h1", { className: "font-bold text-lg tracking-wider text-[#B8860B]" }, "MyTrading"),
                                    React.createElement("p", { className: "text-[10px] text-sky-600" }, "Logistics System")
                                 )
                             ),
                             // Mobile Logout Button (Since Mobile Header is removed)
                             React.createElement("button", {
                                onClick: () => setUserData(null),
                                className: "md:hidden text-red-500 p-2"
                             }, React.createElement(LogOut, { size: 20 }))
                        ),
                        
                        // Profile
                         React.createElement("div", { className: "p-6 border-b border-sky-200" },
                            React.createElement("div", { className: "flex items-center gap-3" },
                                React.createElement("div", { className: "w-10 h-10 rounded-full bg-sky-600 flex items-center justify-center text-sm font-bold text-white shadow-sm" }, 
                                     userRole ? userRole.substring(0,2).toUpperCase() : 'GS'
                                ),
                                React.createElement("div", null,
                                    React.createElement("p", { className: "font-bold text-sm capitalize text-slate-800" }, userRole || 'Guest'),
                                    React.createElement("div", { className: "flex items-center gap-1.5" },
                                        React.createElement("div", { className: "w-2 h-2 rounded-full bg-emerald-500" },),
                                        React.createElement("p", { className: "text-xs text-slate-500" }, "Online")
                                    )
                                )
                            )
                         ),

                        // Menu
                        React.createElement("nav", { className: "flex-1 overflow-y-auto py-6 px-3 space-y-1" },
                            menuItems.map(item => (
                                 React.createElement("button", {
                                    key: item.v,
                                    onClick: () => setView(item.v),
                                    className: `w-full flex items-center gap-3 px-3 py-3 rounded-lg text-sm font-medium transition-all ${
                                        view === item.v 
                                        ? 'bg-white text-sky-600 shadow-sm ring-1 ring-sky-100' 
                                        : 'text-slate-600 hover:bg-white/60 hover:text-sky-700'
                                    }`
                                 },
                                    React.createElement(item.i, { size: 20 }),
                                    React.createElement("span", null, item.l)
                                 )
                            ))
                        ),

                        // Bottom Actions
                        React.createElement("div", { className: "p-4 border-t border-sky-200 space-y-2 hidden md:block" },
                             userRole === 'admin' && React.createElement("button", {
                                onClick: () => setView('settings'),
                                className: `w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm transition-colors ${view === 'settings' ? 'bg-sky-100 text-sky-800' : 'text-slate-500 hover:text-sky-700 hover:bg-white/60'}`
                             },
                                React.createElement(Settings, { size: 18 }),
                                "Pengaturan"
                             ),
                             React.createElement("button", {
                                onClick: () => setUserData(null),
                                className: "w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-red-500 hover:bg-red-50 transition-colors"
                             },
                                React.createElement(LogOut, { size: 18 }),
                                "Keluar"
                             )
                        )
                    ),

                    // MAIN CONTENT
                    React.createElement("main", { className: "flex-1 overflow-y-auto h-screen p-4 md:p-8 bg-slate-50/50" },
                        // Conditional Rendering based on Roles & Views
                        (userRole === 'admin' || userRole === 'timbang') && view === 'register' && React.createElement(RegisterTruckForm, { user, trucks }),
                        
                        (userRole === 'admin' || userRole === 'transporters') && view === 'transporters' && React.createElement(MasterTransporterForm, { user }), 
                        userRole === 'admin' && view === 'items' && React.createElement(MasterItemForm, { user }),
                        
                        // Pass userData to TransactionForm
                        (userRole === 'admin' || userRole === 'user') && view === 'transaction' && React.createElement(TransactionForm, { user, trucks, userData }),
                        (userRole === 'admin' || userRole === 'user') && view === 'tracking' && React.createElement(LiveTrackingPage, { user }), // Render Live Tracking
                        
                        userRole === 'admin' && view === 'history' && React.createElement(TransactionHistory, { user, userData }),
                        // Allow User to see Recap
                        (userRole === 'admin' || userRole === 'user') && view === 'recap' && React.createElement(RecapPage, { user }),
                        
                        userRole === 'admin' && view === 'settings' && React.createElement(SettingsPage, { user })
                    )
                )
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
